<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>自動車ローン シミュレーターPRO（修正：59回目残高=残価）</title>
    <meta name="theme-color" content="#0f172a" />
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%230ea5e9' d='M8 36a4 4 0 0 1 4-4h40a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4z'/%3E%3Ccircle cx='20' cy='50' r='6' fill='%23e2e8f0'/%3E%3Ccircle cx='44' cy='50' r='6' fill='%23e2e8f0'/%3E%3Cpath fill='%231f2937' d='M9 34c2-7 8-12 15-12h16c7 0 13 5 15 12z'/%3E%3C/svg%3E" />
    <link rel="manifest" href="/manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
<meta name="theme-color" content="#0f172a">

    
    <style>
        :root {
            --bg: #0b1020;
            --surface: #0e1426;
            --muted: #9aa4b2;
            --text: #e6ecf3;
            --line: #1f2a44;
            --accent: #0ea5e9;
            --accent-2: #22d3ee;
            --radius: 16px;
            --gap: 14px;
            --shadow: 0 14px 45px rgba(0, 0, 0, .38);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            color: var(--text);
            background:
                radial-gradient(1200px 800px at 120% -10%, rgba(34, 211, 238, .08), transparent 60%),
                radial-gradient(1000px 600px at -10% 110%, rgba(14, 165, 233, .10), transparent 60%),
                var(--bg);
            font: clamp(16px, 1.2vw + 12px, 18px)/1.65 system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        }

        header {
            padding: 24px 18px 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            display: grid;
            place-items: center;
            box-shadow: var(--shadow)
        }

        h1 {
            margin: 0;
            font-size: clamp(20px, 1.6vw + 14px, 26px);
            letter-spacing: .2px
        }

        .sub {
            color: var(--muted);
            font-size: clamp(12px, .6vw + 10px, 13.5px);
            margin-top: 2px
        }

        main {
            padding: 0 18px 28px;
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            max-width: 1280px;
            margin: 0 auto;
        }

        @media (max-width: 980px) {
            main {
                grid-template-columns: 1fr
            }
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent 18%);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin: 0;
            padding: 16px 16px;
            font-size: clamp(15px, .6vw + 12px, 18px);
            border-bottom: 1px dashed var(--line);
            color: #cbd5e1
        }

        .card .content {
            padding: 14px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px
        }

        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px
        }

        .row-bonus-resid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0
        }

        .field label {
            font-size: clamp(12.5px, .6vw + 10px, 14px);
            color: var(--muted)
        }

        .field input,
        .field select {
            background: #0a1124;
            border: 1px solid #1b2743;
            color: #e6ecf3;
            border-radius: 12px;
            padding: 14px 14px;
            outline: none;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            font-size: 20px;
        }

        .hint {
            font-size: clamp(12px, .5vw + 10px, 13px);
            color: #7b879a
        }

        .muted {
            color: var(--muted)
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 0 14px 16px
        }

        button {
            appearance: none;
            border: none;
            cursor: pointer;
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            color: #001018;
            font-weight: 700;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-height: 44px;
            font-size: 16px
        }

        button.secondary {
            background: #0a1124;
            color: #e6ecf3;
            border: 1px solid #1b2743;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 8px;
            padding: 10px 14px 0;
            flex-wrap: wrap
        }

        .tab {
            padding: 10px 12px;
            border: 1px solid #1b2743;
            border-radius: 999px;
            font-size: 14px;
            color: #9fb3d1;
            cursor: pointer
        }

        .tab.active {
            background: #0a1124
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            padding: 14px;
        }

        .tile {
            background: #0a1124;
            border: 1px solid #1b2743;
            border-radius: 14px;
            padding: 14px
        }

        .tile .label {
            font-size: 13px;
            color: #9aa4b2
        }

        .tile .value {
            font-size: 28px;
            font-weight: 800;
            margin-top: 6px;
            font-variant-numeric: tabular-nums;
            letter-spacing: .3px
        }

        .tile .subv {
            font-size: 12.5px;
            color: #7b879a;
            margin-top: 4px
        }

        .schedule {
            padding: 6px 14px 16px
        }

        details {
            border-top: 1px dashed var(--line);
        }

        details summary {
            padding: 12px 0;
            cursor: pointer;
            color: #cbd5e1;
            font-size: 16px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            border-bottom: 1px solid #12203f;
            padding: 10px 10px;
            text-align: right;
            white-space: nowrap
        }

        th {
            color: #9fb3d1;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: #0d1427
        }

        td:first-child,
        th:first-child {
            text-align: left
        }

        .footer {
            padding: 10px 14px 20px;
            color: #7b879a;
            font-size: 12.5px
        }

        .chartWrap {
            padding: 0 14px 18px
        }

        canvas {
            width: 100%;
            height: 340px;
            display: block;
            background: #0a1124;
            border: 1px solid #1b2743;
            border-radius: 12px
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px
        }

        .chip {
            padding: 8px 10px;
            border: 1px solid #1b2743;
            border-radius: 999px;
            font-size: 13px;
            color: #9fb3d1
        }

        .mode {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .mode label {
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #1b2743;
            border-radius: 999px;
            padding: 8px 12px;
            font-size: 14px;
            color: #9fb3d1
        }

        /* === 実質年率 ±ボタン（小型化） === */
        .spinV {
            position: relative;
            display: flex;
            align-items: stretch;
            width: 100%
        }

        .spinV input {
            flex: 1;
            padding-right: 48px;
            text-align: right;
            font-variant-numeric: tabular-nums;
            letter-spacing: .3px
        }

        .spinV .vstep {
            position: absolute;
            top: 50%;
            right: 6px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .spinV .step {
            appearance: none;
            border: 1px solid #1b2743;
            background: #0a1124;
            color: #e6ecf3;
            border-radius: 6px;
            width: 32px;
            height: 22px;
            font-size: 12px;
            font-weight: 800;
            line-height: 1;
            display: grid;
            place-items: center;
            cursor: pointer
        }

        .spinV .step:active {
            transform: translateY(1px)
        }

        /* === レイアウト微調整：年率だけ広く／開始月だけ少し狭く === */
        @media (min-width:701px) {
            .row3 {
                grid-template-columns: minmax(110px, .9fr) minmax(110px, .9fr) minmax(220px, 1.2fr)
            }

            #months {
                max-width: 120px;
            }

            #rateWrap {
                max-width: 280px
            }

            /* ちょい広げる */
            #startMonth {
                min-width: 200px;
                width: 100%
            }

            /* ちょい狭める */
            .spinV .step {
                width: 26px;
                /* ← 横幅を小さく */
                height: 20px;
                /* ← 高さを小さく */
                font-size: 11px;
                /* ← 文字も小さく */
                border-radius: 4px;
            }

            /* 年率入力の数字がボタンに隠れないよう余白をもう少し確保 */
            .spinV input {
                padding-right: 48px;
            }

            /* ボタンの配置微調整（ほんの少し右へ＆間隔） */
            .spinV .vstep {
                right: 6px;
                gap: 2px;
            }

            /* ボタンは今のままでもOK。さらに小さくしたいならコメントアウト解除 */
            /*
.spinV .step { width: 30px; height: 22px; font-size: 12px; }
*/
        }

        /* Responsive */
        @media (max-width:700px) {

            .row,
            .row3 {
                grid-template-columns: 1fr
            }

            .grid2 {
                grid-template-columns: 1fr
            }

            .tile .value {
                font-size: 30px
            }

            table {
                font-size: 15px
            }

            th,
            td {
                padding: 12px 10px
            }

            canvas {
                height: 380px
            }

            .field input,
            .field select {
                font-size: clamp(22px, 6vw, 30px);
                padding: 16px 16px;
                min-height: 56px
            }

            .field label {
                font-size: clamp(14px, 3.6vw, 18px)
            }

            button {
                min-height: 54px;
                font-size: 17px
            }

            .spinV input {
                padding-right: 56px
            }

            .spinV .step {
                width: 36px;
                height: 26px;
                font-size: 13px
            }
        }

        /* アシスト表示 */
        .assist {
            display: block;
            font-size: 11px;
            color: #7a8699;
            margin-top: 2px;
            cursor: pointer;
        }

        .assist:hover {
            color: #a5b4fc;
            text-decoration: underline;
        }

        /* --- 年率（.num-control）を少し広く、開始月を少し狭く --- */
        @media (min-width: 701px) {

            /* 年率：入力＋±ボタンの箱をちょっと広く */
            .num-control {
                max-width: 320px;
            }

            /* 年率の入力欄に少し余裕（±ボタンが被らないように） */
            .num-control input#rate {
                padding-right: 8px;
                /* 既に右側にボタンが別配置なので少なめでOK */
            }

            /* 開始月：ほんの少しだけ狭める */
            #startMonth {
                min-width: 200px;
                /* 既存は 220px になっているので上書き */
            }

            /* アシストの可読性アップ（色＆余白） */
            .assist {
                display: block;
                margin-top: 6px;
                font-size: 12px;
                color: #9fb3d1;
            }

            .assist:hover {
                color: #cfe1ff;
                text-decoration: underline;
            }


        }

        /* アシスト（前回値ヒント）を見やすく */
        .assist {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #9fb3d1;
        }

        .assist:hover {
            color: #cfe1ff;
            text-decoration: underline;
        }

        /* 実質年率の±ボタンを小さく強制 */
        .spinV .step {
            width: 20px !important;
            /* ← 小さめに強制 */
            height: 14px !important;
            /* ← 高さも小さめに */
            font-size: 10px !important;
            /* ← 文字も縮小 */
            border-radius: 4px !important;
            padding: 0 !important;
        }

        .spinV .vstep {
            gap: 4px !important;
            /* 上下の間隔も狭く */
            right: 4px !important;
            /* 数値との距離を調整 */
        }

        .spinV input {
            padding-right: 44px !important;
            /* 数字が見えるよう余白調整 */
        }
    </style>
</head>
<button id="btnInstall" hidden>インストール</button>

<body>
    <header>
        <div class="logo">🚗</div>
        <div>
            <h1>自動車ローン シミュレーターPRO</h1>
            <div class="sub">元利均等／元金均等・ボーナス（加算/総額指定）・残価％/円（相互連動）・グラフ表示</div>
        </div>
    </header>

    <main>
        <section class="card" id="inputs">
            <h2>入力（日本国内向け）</h2>
            <div class="content">
                <div class="row">
                    <div class="field">
                        <label>車両本体価格 <span class="muted">（税込想定）</span></label>
                        <input type="text" data-num="money" id="price" value="3000000" inputmode="numeric"
                            autocomplete="off" autofocus>
                    </div>
                    <div class="field">
                        <label>オプション・諸費用</label>
                        <input type="text" data-num="money" id="fees" value="200000" inputmode="numeric"
                            autocomplete="off">
                    </div>
                </div>

                <div class="row">
                    <div class="field">
                        <label>頭金</label>
                        <input type="text" data-num="money" id="down" value="300000" inputmode="numeric"
                            autocomplete="off">
                    </div>
                    <div class="field">
                        <label>下取り（差引後）</label>
                        <input type="text" data-num="money" id="tradein" value="0" inputmode="numeric"
                            autocomplete="off">
                    </div>
                </div>

                <div class="row3">
                    <div class="field" id="rateWrap">
                        <label>実質年率（%）</label>
                        <div class="spinV">
                            <input type="text" id="rate" value="3.9" inputmode="decimal" pattern="[0-9]*\.?[0-9]*"
                                autocomplete="off">
                            <div class="vstep">
                                <button type="button" class="step" id="rateInc" aria-label="年率を0.05上げる">▲</button>
                                <button type="button" class="step" id="rateDec" aria-label="年率を0.05下げる">▼</button>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label>返済回数（月）</label>
                        <input type="number" id="months" value="60" min="1" step="1">
                    </div>
                    <div class="field">
                        <label>開始月 <span class="muted">（初回引落想定）</span></label>
                        <input type="month" id="startMonth">
                    </div>
                </div>

                <div class="row-bonus-resid">
                    <div class="field" id="bonusField">
                        <label>ボーナス額</label>
                        <input type="text" data-num="money" id="bonusAmount" value="0" inputmode="numeric"
                            autocomplete="off">
                        <div style="margin-top:6px">
                            <select id="bonusType">
                                <option value="addon" selected>加算（通常月に上乗せ）</option>
                                <option value="total">総額指定（その月の総支払額）</option>
                            </select>
                        </div>
                        <div class="chips" style="margin-top:8px">
                            <label class="chip"><input type="checkbox" id="bonusDec"> 12月</label>
                            <label class="chip"><input type="checkbox" id="bonusJan" checked> 1月</label>
                            <label class="chip"><input type="checkbox" id="bonusFeb"> 2月</label>
                            <label class="chip"><input type="checkbox" id="bonusJul"> 7月</label>
                            <label class="chip"><input type="checkbox" id="bonusAug" checked> 8月</label>
                            <label class="chip"><input type="checkbox" id="bonusSep"> 9月</label>
                        </div>
                        <div class="hint">総額指定は通常支払額を下回れません（自動で通常額まで引き上げ）。</div>
                    </div>
                    <div class="field">
                        <label>残価設定</label>
                        <div class="grid2">
                            <input type="text" data-num="money" id="balloonYen" value="0" inputmode="numeric"
                                autocomplete="off" placeholder="残価（円）">
                            <input type="text" id="balloonPct" value="0" inputmode="decimal" pattern="[0-9]*\.?[0-9]*"
                                autocomplete="off" placeholder="残価（％）">
                        </div>
                        <div class="hint" id="balloonHint">
                            残価率の基準：<strong>車両本体価格（税込）</strong>。上限は元金の90%（残価は<strong>百円単位</strong>）。
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="field">
                        <label>端数処理</label>
                        <select id="rounding">
                            <option value="none">しない（円単位）</option>
                            <option value="down">毎回：切り捨て</option>
                            <option value="nearest" selected>毎回：四捨五入</option>
                            <option value="up">毎回：切り上げ</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>返済方式</label>
                        <div class="mode">
                            <label><input type="radio" name="mode" value="annuity" checked> 元利均等</label>
                            <label><input type="radio" name="mode" value="equal_principal"> 元金均等</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button id="run">計算する</button>
                <button id="reset" class="secondary">リセット</button>
                <button id="print" class="secondary">PDF出力</button>
                <button id="export" class="secondary">CSV書き出し</button>
            </div>
        </section>

        <section class="card">
            <div class="tabs">
                <div class="tab active" id="tab1">結果サマリー</div>
                <div class="tab" id="tab2">残高グラフ</div>
            </div>
            <div id="panel1">
                <div class="kpi">
                    <div class="tile">
                        <div class="label">借入金額（元金）</div>
                        <div id="k_principal" class="value">-</div>
                        <div class="subv">（総支払 - 利息 - 手元支払）</div>
                    </div>
                    <div class="tile">
                        <div class="label">毎月の基本返済（ボーナス除く）</div>
                        <div id="k_monthly" class="value">-</div>
                        <div class="subv"><span id="k_mode">元利均等</span>・選択月はボーナス反映</div>
                    </div>
                    <div class="tile">
                        <div class="label">総支払額</div>
                        <div id="k_total" class="value">-</div>
                        <div class="subv">うち利息：<span id="k_interest">-</span></div>
                    </div>
                </div>
                <div class="schedule">
                    <details id="detail">
                        <summary>返済予定表を開く</summary>
                        <div style="overflow:auto; max-height:55vh; margin-top:10px">
                            <table id="tbl">
                                <thead>
                                    <tr>
                                        <th>回</th>
                                        <th>支払日</th>
                                        <th>支払額</th>
                                        <th>うちボーナス</th>
                                        <th>うち残価</th>
                                        <th>利息</th>
                                        <th>元金</th>
                                        <th>残高</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </details>
                </div>
                <div class="footer" id="testStatus"></div>
            </div>
            <div id="panel2" style="display:none">
                <div class="chartWrap"><canvas id="chart" width="800" height="320" aria-label="残高の推移"></canvas></div>
                <div class="footer">残高グラフ：縦軸＝残高（円）、横軸＝回数（1〜N）。</div>
            </div>
        </section>
    </main>

    <script>
        (function () {
            const yen = n => n.toLocaleString('ja-JP', { maximumFractionDigits: 0 });
            const nextMonth = d => new Date(d.getFullYear(), d.getMonth() + 1, 1);
            const roundUnit = (n, u = 100) => Math.round((+n || 0) / u) * u;
            function roundPay100(val, mode) {
                const u = 100;
                if (mode === 'down') return Math.floor(val / u) * u;
                if (mode === 'up') return Math.ceil(val / u) * u;
                return Math.round(val / u) * u;
            }

            /* 入力補助 */
            function enforceDotDecimalOnly(input) {
                let composing = false;
                const toHalf = s => s.replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 48)).replace(/[．｡。･・·•]/g, '.').replace(/[，、､,]/g, '.');
                const sanitize = () => { let v = toHalf(input.value || ''); v = v.replace(/[^0-9.]/g, ''); const i = v.indexOf('.'); if (i !== -1) { v = v.slice(0, i + 1) + v.slice(i + 1).replace(/\./g, ''); } input.value = v; };
                input.addEventListener('compositionstart', () => composing = true);
                input.addEventListener('compositionend', () => { composing = false; sanitize(); });
                input.addEventListener('beforeinput', e => {
                    if (composing || e.isComposing) return;
                    if (e.inputType === 'insertText' && e.data) {
                        const d = e.data.replace(/[．｡。･・·•]/g, '.');
                        if (!/^[0-9.]$/.test(d)) { e.preventDefault(); return; }
                        if (d === '.' && input.value.includes('.')) { e.preventDefault(); return; }
                    }
                });
                input.addEventListener('keydown', e => {
                    if (composing || e.isComposing) return;
                    if (e.ctrlKey || e.metaKey || e.altKey) return;
                    const ok = new Set(['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End', 'Enter']);
                    if (ok.has(e.key)) return;
                    if (/^[0-9.]$/.test(e.key)) { if (e.key === '.' && input.value.includes('.')) e.preventDefault(); return; }
                    e.preventDefault();
                });
                input.addEventListener('paste', () => setTimeout(sanitize, 0));
                input.addEventListener('input', () => { if (!composing) sanitize(); });
                input.addEventListener('change', sanitize);
                sanitize();
            }
            function enforceNumericMoney(input) {
                let composing = false;
                const toHalf = s => s.replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 48)).replace(/[，、､,\s]/g, '');
                const sanitize = () => { let v = toHalf(input.value || ''); v = v.replace(/[^0-9]/g, ''); input.value = v; };
                input.addEventListener('compositionstart', () => composing = true);
                input.addEventListener('compositionend', () => { composing = false; sanitize(); });
                input.addEventListener('input', () => { if (!composing) sanitize(); });
                input.addEventListener('paste', () => setTimeout(sanitize, 0));
                input.addEventListener('change', sanitize);
                sanitize();
            }

            /* 要素 */
            const priceEl = document.getElementById('price');
            const feesEl = document.getElementById('fees');
            const downEl = document.getElementById('down');
            const tradeinEl = document.getElementById('tradein');
            const rateEl = document.getElementById('rate');
            const monthsEl = document.getElementById('months');
            const startMonthEl = document.getElementById('startMonth');
            const bonusAmountEl = document.getElementById('bonusAmount');
            const bonusTypeEl = document.getElementById('bonusType');
            const balloonYenEl = document.getElementById('balloonYen');
            const balloonPctEl = document.getElementById('balloonPct');
            const roundingEl = document.getElementById('rounding');

            enforceDotDecimalOnly(rateEl);
            [priceEl, feesEl, downEl, tradeinEl, bonusAmountEl, balloonYenEl].forEach(enforceNumericMoney);

            /* 年率の±ボタン */
            const rateDecBtn = document.getElementById('rateDec');
            const rateIncBtn = document.getElementById('rateInc');
            const minRate = 0, maxRate = 99.99, stepRate = 0.1;
            const parseRate = () => { const v = (rateEl.value || '').replace(/[^0-9.]/g, ''); return parseFloat(v) || 0; };
            const setRate = v => { v = Math.min(maxRate, Math.max(minRate, Math.round(v * 100) / 100)); rateEl.value = String(v); rateEl.dispatchEvent(new Event('input', { bubbles: true })); };
            rateDecBtn.addEventListener('click', () => setRate(parseRate() - stepRate));
            rateIncBtn.addEventListener('click', () => setRate(parseRate() + stepRate));

            /* ボーナス月は最大2つ */
            (function setupBonusLimit() {
                const boxes = Array.from(document.querySelectorAll('#bonusField input[type="checkbox"]'));
                const apply = () => {
                    const checked = boxes.filter(b => b.checked);
                    const over = checked.length >= 2;
                    boxes.forEach(b => {
                        if (!b.checked) { b.disabled = over; b.parentElement?.classList.toggle('disabled', over); }
                        else { b.disabled = false; b.parentElement?.classList.remove('disabled'); }
                    });
                };
                boxes.forEach(b => b.addEventListener('change', apply));
                apply();
            })();

            /* 残価 率↔円 連動 */
            let balloonLast = 'yen', syncing = false;
            const loanPrincipal = () => Math.max(0, (+priceEl.value || 0) + (+feesEl.value || 0) - (+downEl.value || 0) - (+tradeinEl.value || 0));
            const vehicleBasePrice = () => +priceEl.value || 0;
            const clampBalloonYen = y => Math.max(0, Math.min(y, loanPrincipal() * 0.9));
            const clampBalloonPct = p => Math.max(0, Math.min(p, 90));
            function syncFromPct() {
                if (syncing) return; syncing = true;
                const base = vehicleBasePrice(); const raw = +balloonPctEl.value || 0; const eff = clampBalloonPct(raw);
                const ideal = roundUnit(base * eff / 100, 100); const y = clampBalloonYen(ideal);
                balloonYenEl.value = String(y | 0);
                document.getElementById('balloonHint').textContent = `基準=車両本体: ¥${Math.round(base).toLocaleString('ja-JP')}｜入力 ${raw}% → ${eff.toFixed(1)}% → 残価 ≈ ¥${y.toLocaleString('ja-JP')}（上限=元金90%／百円単位）`;
                balloonLast = 'pct'; syncing = false;
            }
            function syncFromYen() {
                if (syncing) return; syncing = true;
                const base = vehicleBasePrice(); const raw = +balloonYenEl.value || 0;
                const eff = clampBalloonYen(roundUnit(raw, 100)); const pct = base > 0 ? (eff / base) * 100 : 0;
                balloonPctEl.value = clampBalloonPct(pct).toFixed(1); balloonYenEl.value = String(eff | 0);
                document.getElementById('balloonHint').textContent = `基準=車両本体: ¥${Math.round(base).toLocaleString('ja-JP')}｜入力 ¥${raw.toLocaleString('ja-JP')} → 計算値 ¥${eff.toLocaleString('ja-JP')}（率 ≈ ${clampBalloonPct(pct).toFixed(1)}%）`;
                balloonLast = 'yen'; syncing = false;
            }
            balloonPctEl.addEventListener('input', syncFromPct);
            balloonPctEl.addEventListener('change', syncFromPct);
            balloonYenEl.addEventListener('input', syncFromYen);
            balloonYenEl.addEventListener('change', syncFromYen);

            /* 入力収集 */
            function getInputs() {
                const price = +priceEl.value || 0, fees = +feesEl.value || 0, down = +downEl.value || 0, tradein = +tradeinEl.value || 0;
                const rateY = +rateEl.value || 0, months = Math.max(1, (+monthsEl.value | 0));
                const startStr = startMonthEl.value; const startDate = startStr ? new Date(startStr + '-01') : new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                const bonusAmount = +bonusAmountEl.value || 0; const bonusType = (bonusTypeEl || { value: 'addon' }).value;
                const id2m = { bonusJan: 0, bonusFeb: 1, bonusJul: 6, bonusAug: 7, bonusSep: 8, bonusDec: 11 };
                const bonusMonths = []; Object.entries(id2m).forEach(([id, m]) => { const el = document.getElementById(id); if (el && el.checked) bonusMonths.push(m); });
                const balloonYen = clampBalloonYen(+balloonYenEl.value || 0); const balloonPct = clampBalloonPct(+balloonPctEl.value || 0);
                const rounding = roundingEl.value; const mode = document.querySelector('input[name="mode"]:checked').value;
                return { price, fees, down, tradein, rateY, months, startDate, bonusAmount, bonusType, bonusMonths, balloonPct, balloonYen, rounding, mode, balloonLast };
            }

            /* 残価確定（常に百円単位） */
            function resolveBalloon(principal, last, pct, yen, basePrice) {
                const base = Math.max(0, +basePrice || 0);
                const fromPct = base * (Math.max(0, +pct || 0) / 100);
                const candidate = (last === 'pct') ? fromPct : Math.max(0, +yen || 0);
                const clamped = Math.max(0, Math.min(candidate, principal * 0.9));
                return roundUnit(clamped, 100);
            }

            /* 返済スケジュール */
            function buildSchedule(inp) {
                const r = inp.rateY / 100 / 12;
                const gross = inp.price + inp.fees;
                const principal = Math.max(0, gross - inp.down - inp.tradein);
                const balloon = resolveBalloon(principal, inp.balloonLast, inp.balloonPct, inp.balloonYen, inp.price);
                const bonusSet = new Set(inp.bonusMonths);
                const isTotal = inp.bonusType === 'total';
                const monthsAmort = balloon > 0 ? Math.max(0, inp.months - 1) : inp.months;

                if (inp.mode === 'annuity') {
                    if (monthsAmort === 0) {
                        const rows = [{ idx: 1, date: new Date(inp.startDate), pay: balloon, bonus: 0, balloon, interest: 0, principal: balloon, balance: 0 }];
                        return { mode: '元利均等', principal, baseMonthly: 0, totalPay: balloon, totalInterest: 0, totalBonus: 0, balloon, rows };
                    }

                    /* 二分探索（ボーナス条件＋百円丸めを反映） */
                    const feasible = base => {
                        let bal = principal; let d = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
                        for (let i = 0; i < monthsAmort; i++) {
                            const isB = bonusSet.has(d.getMonth());
                            let pay = isB ? (isTotal ? Math.max(inp.bonusAmount, base) : base + inp.bonusAmount) : base;
                            pay = roundPay100(pay, inp.rounding);
                            const interest = Math.round(bal * r);
                            const prin = Math.max(0, pay - interest);
                            bal = Math.max(0, bal - prin);
                            d = nextMonth(d);
                        }
                        return bal <= balloon + 1e-6;
                    };
                    let lo = 0, hi = Math.max(1, principal / Math.max(1, monthsAmort));
                    while (!feasible(hi)) hi = Math.min(hi * 1.6, principal * 2 + 1e6);
                    for (let k = 0; k < 60; k++) { const mid = (lo + hi) / 2; feasible(mid) ? hi = mid : lo = mid; }
                    const baseMonthly = hi; // 探索値（未丸め）

                    /* 初回だけ1円単位で微調整 → 最終回直前の残高＝残価 を厳密に */
                    const startMonth = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
                    const isFirstBonus = bonusSet.has(startMonth.getMonth());
                    const stdFirstRounded = roundPay100(
                        isFirstBonus ? (isTotal ? Math.max(inp.bonusAmount, baseMonthly) : baseMonthly + inp.bonusAmount) : baseMonthly
                        , inp.rounding);

                    const fbalFirst = (firstPay) => {
                        let bal = principal; let d = new Date(startMonth);
                        for (let i = 0; i < monthsAmort; i++) {
                            const isB = bonusSet.has(d.getMonth());
                            let pay;
                            if (i === 0) {
                                pay = Math.round(firstPay);
                            } else {
                                pay = isB ? (isTotal ? Math.max(inp.bonusAmount, baseMonthly) : baseMonthly + inp.bonusAmount) : baseMonthly;
                                pay = roundPay100(pay, inp.rounding);
                            }
                            const interest = Math.round(bal * r);
                            const prin = Math.max(0, pay - interest);
                            bal = Math.max(0, bal - prin);
                            d = nextMonth(d);
                        }
                        return bal;
                    };
                    // 1円微調整の二分探索
                    let l = -200000, h = 200000;
                    const sgn = x => (x > 0) - (x < 0);
                    let fL = fbalFirst(stdFirstRounded + l) - balloon, fH = fbalFirst(stdFirstRounded + h) - balloon, ex = 0;
                    while (sgn(fL) * sgn(fH) > 0 && ex < 6) { l *= 2; h *= 2; fL = fbalFirst(stdFirstRounded + l) - balloon; fH = fbalFirst(stdFirstRounded + h) - balloon; ex++; }
                    for (let t = 0; t < 20; t++) { const m = Math.floor((l + h) / 2); const fM = fbalFirst(stdFirstRounded + m) - balloon; if (fM === 0) { l = h = m; break; } if (sgn(fL) * sgn(fM) <= 0) { h = m; fH = fM; } else { l = m; fL = fM; } }
                    const firstAdjPay = Math.round(stdFirstRounded + Math.floor((l + h) / 2));

                    // 明細生成
                    const rows = []; let bal = principal, totalPay = 0, totalInt = 0, totalBonus = 0; let d = new Date(startMonth);
                    for (let i = 0; i < monthsAmort; i++) {
                        const isB = bonusSet.has(d.getMonth());
                        let pay = (i === 0)
                            ? firstAdjPay
                            : roundPay100(isB ? (isTotal ? Math.max(inp.bonusAmount, baseMonthly) : baseMonthly + inp.bonusAmount) : baseMonthly, inp.rounding);
                        const interest = Math.round(bal * r);
                        const prin = Math.max(0, pay - interest);
                        bal = Math.max(0, bal - prin);

                        const usual = roundPay100(isB ? (isTotal ? Math.max(inp.bonusAmount, baseMonthly) : baseMonthly) : baseMonthly, inp.rounding);
                        const bonusDisp = Math.max(0, pay - usual);

                        totalPay += pay; totalInt += Math.max(0, interest); totalBonus += bonusDisp;
                        rows.push({ idx: i + 1, date: new Date(d), pay, bonus: bonusDisp ? bonusDisp : 0, balloon: 0, interest, principal: prin, balance: bal });
                        d = nextMonth(d);
                    }
                    if (balloon > 0) {
                        rows.push({ idx: monthsAmort + 1, date: new Date(d), pay: balloon, bonus: 0, balloon, interest: 0, principal: balloon, balance: 0 });
                        totalPay += balloon;
                    }
                    return { mode: '元利均等', principal, baseMonthly: roundPay100(baseMonthly, inp.rounding), totalPay: Math.round(totalPay), totalInterest: Math.round(totalInt), totalBonus, balloon, rows };

                } else {
                    /* 元金均等：各月の通常額=（計画元金＋利息）。総額指定は下限max(指定,通常) */
                    if (monthsAmort === 0) {
                        const rows = [{ idx: 1, date: new Date(inp.startDate), pay: balloon, bonus: 0, balloon, interest: 0, principal: balloon, balance: 0 }];
                        return { mode: '元金均等', principal, baseMonthly: 0, totalPay: balloon, totalInterest: 0, totalBonus: 0, balloon, rows };
                    }

                    const rows = []; let bal = principal, totalPay = 0, totalInt = 0, totalBonus = 0;
                    let d = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
                    const monthlyPrincipal = Math.max(0, (principal - balloon) / monthsAmort);
                    let firstBaseMonthly = 0;

                    for (let i = 0; i < monthsAmort; i++) {
                        const interest = Math.round(bal * r);
                        const prinPlan = (i === monthsAmort - 1 ? Math.max(0, bal) : monthlyPrincipal);
                        const usual = prinPlan + interest;
                        pay = isTotal ? Math.max(inp.bonusAmount, usual) : (usual + inp.bonusAmount);
                        let pay;
                        if (bonusSet.has(d.getMonth())) {
                            pay =// 総額指定は max(指定額, 通常額)
                                isTotal ? Math.max(inp.bonusAmount, baseMonthly) : baseMonthly + inp.bonusAmount

                        } else {
                            pay = usual;
                        }
                        pay = roundPay100(pay, inp.rounding);
                        const prin = Math.max(0, pay - interest);
                        bal = Math.max(0, bal - prin);

                        if (i === 0) firstBaseMonthly = roundPay100(usual, inp.rounding);
                        const bonusDisp = Math.max(0, pay - roundPay100(usual, inp.rounding));

                        totalPay += pay; totalInt += Math.max(0, interest); totalBonus += bonusDisp;
                        rows.push({ idx: i + 1, date: new Date(d), pay, bonus: bonusDisp ? bonusDisp : 0, balloon: 0, interest, principal: prin, balance: bal });
                        d = nextMonth(d);
                    }
                    if (balloon > 0) {
                        rows.push({ idx: monthsAmort + 1, date: new Date(d), pay: balloon, bonus: 0, balloon, interest: 0, principal: balloon, balance: 0 });
                        totalPay += balloon;
                    }
                    return { mode: '元金均等', principal, baseMonthly: firstBaseMonthly, totalPay: Math.round(totalPay), totalInterest: Math.round(totalInt), totalBonus, balloon, rows };
                }
            }

            /* 表示系 */
            const k_principal = document.getElementById('k_principal');
            const k_monthly = document.getElementById('k_monthly');
            const k_total = document.getElementById('k_total');
            const k_interest = document.getElementById('k_interest');
            const k_mode = document.getElementById('k_mode');
            const chart = document.getElementById('chart');
            const panel1 = document.getElementById('panel1');
            const panel2 = document.getElementById('panel2');

            function fmtDate(d) { const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'); return `${y}/${m}`; }
            function drawChart(values) {
                const c = chart, ratio = Math.max(1, window.devicePixelRatio || 1);
                const cssW = c.clientWidth, cssH = c.clientHeight;
                if (c.width !== Math.round(cssW * ratio) || c.height !== Math.round(cssH * ratio)) { c.width = Math.round(cssW * ratio); c.height = Math.round(cssH * ratio); }
                const ctx = c.getContext('2d'); ctx.setTransform(ratio, 0, 0, ratio, 0, 0); ctx.clearRect(0, 0, cssW, cssH);
                const W = cssW, H = cssH, padL = 56, padR = 16, padT = 12, padB = 30, w = W - padL - padR, h = H - padT - padB, n = values.length;
                const maxV = Math.max(...values, 0), minV = Math.min(...values, 0); const y = v => padT + h - (h * (v - minV) / (maxV - minV || 1)); const x = i => padL + (w * i / Math.max(1, n - 1));
                ctx.strokeStyle = '#1b2743'; ctx.lineWidth = 1; ctx.beginPath(); for (let k = 0; k <= 4; k++) { const gy = padT + h * k / 4; ctx.moveTo(padL, gy); ctx.lineTo(W - padR, gy); } ctx.stroke();
                ctx.fillStyle = '#9fb3d1'; ctx.font = '13px system-ui, sans-serif'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
                for (let k = 0; k <= 4; k++) { const gy = padT + h * k / 4; const val = Math.round(maxV - (maxV - minV) * k / 4); ctx.fillText('¥' + val.toLocaleString('ja-JP'), padL - 8, gy); }
                ctx.textAlign = 'center'; ctx.textBaseline = 'top'; const step = Math.max(1, Math.floor(n / 8)); for (let i = 0; i < n; i += step) { ctx.fillText(String(i + 1), x(i), H - padB + 6); }
                ctx.beginPath(); for (let i = 0; i < n; i++) { const xi = x(i), yi = y(values[i]); if (i === 0) ctx.moveTo(xi, yi); else ctx.lineTo(xi, yi); } ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2; ctx.stroke();
            }

            function render(res) {
                k_principal.textContent = `¥${yen(res.principal)}`;
                k_monthly.textContent = `¥${yen(roundUnit(res.baseMonthly, 1))}`;
                k_total.textContent = `¥${yen(res.totalPay)}`;
                k_interest.textContent = `¥${yen(res.totalInterest)}`;
                k_mode.textContent = res.mode;

                const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
                for (const r of res.rows) {
                    const tr = document.createElement('tr');
                    const cells = [r.idx, fmtDate(r.date), `¥${yen(Math.round(r.pay))}`, r.bonus ? `¥${yen(r.bonus)}` : '—', r.balloon ? `¥${yen(r.balloon)}` : '—', `¥${yen(Math.round(r.interest))}`, `¥${yen(Math.round(r.principal))}`, `¥${yen(Math.round(r.balance))}`];
                    for (const c of cells) { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); }
                    tb.appendChild(tr);
                }
                drawChart(res.rows.map(r => r.balance));
            }

            function toCSV(res) {
                const header = ['回', '支払年月', '支払額', 'ボーナス', '残価', '利息', '元金', '残高'];
                const lines = [header.join(',')];
                for (const r of res.rows) { lines.push([r.idx, fmtDate(r.date), Math.round(r.pay), r.bonus, r.balloon, Math.round(r.interest), Math.round(r.principal), Math.round(r.balance)].join(',')); }
                const meta = [['返済方式', res.mode], ['借入元金', res.principal], ['毎月基本返済(概算)', res.baseMonthly], ['総支払額', res.totalPay], ['総利息', res.totalInterest], ['残価', res.balloon]].map(a => a[0] + ',' + a[1]).join('\n');
                return `データ種別,返済予定表\n${lines.join('\n')}\n\nサマリー\n${meta}`;
            }
            function download(name, text) { const blob = new Blob([text], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); setTimeout(() => URL.revokeObjectURL(url), 2000); }

            /* タブ */
            const tab1 = document.getElementById('tab1'), tab2 = document.getElementById('tab2');
            tab1.addEventListener('click', () => { tab1.classList.add('active'); tab2.classList.remove('active'); panel1.style.display = 'block'; panel2.style.display = 'none'; });
            tab2.addEventListener('click', () => { tab2.classList.add('active'); tab1.classList.remove('active'); panel2.style.display = 'block'; panel1.style.display = 'none'; drawChart([]); });

            /* PDF */
            function printableHTML(res) {
                const rows = res.rows.map(r => {
                    const bonus = r.bonus ? '¥' + yen(r.bonus) : '—';
                    const baln = r.balloon ? '¥' + yen(r.balloon) : '—';
                    return `<tr>
        <td>${r.idx}</td><td>${fmtDate(r.date)}</td>
        <td style="text-align:right">¥${yen(Math.round(r.pay))}</td>
        <td style="text-align:right">${bonus}</td>
        <td style="text-align:right">${baln}</td>
        <td style="text-align:right">¥${yen(Math.round(r.interest))}</td>
        <td style="text-align:right">¥${yen(Math.round(r.principal))}</td>
        <td style="text-align:right">¥${yen(Math.round(r.balance))}</td>
      </tr>`;
                }).join('');
                return `<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"/>
    <title>返済予定表PDF</title>
    <style>
      @page{ size:A4; margin:18mm; }
      body{ font:12px/1.6 -apple-system, system-ui, Meiryo, sans-serif; color:#000 }
      h1{ font-size:18px; margin:0 0 8px }
      table{ width:100%; border-collapse:collapse; font-size:11px }
      th,td{ border-bottom:1px solid #ccc; padding:6px 6px; text-align:left }
      th:nth-child(n+3), td:nth-child(n+3){ text-align:right }
      .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin:10px 0 14px }
      .tile{ border:1px solid #ddd; border-radius:8px; padding:8px }
      .label{ font-size:11px; color:#444 }
      .value{ font-size:16px; font-weight:700 }
    </style></head><body>
    <h1>返済予定表</h1>
    <div class="kpi">
      <div class="tile"><div class="label">借入元金</div><div class="value">¥${yen(res.principal)}</div></div>
      <div class="tile"><div class="label">毎月の基本返済</div><div class="value">¥${yen(res.baseMonthly)}（${res.mode}）</div></div>
      <div class="tile"><div class="label">総支払額 / 利息</div><div class="value">¥${yen(res.totalPay)} / ¥${yen(res.totalInterest)}</div></div>
    </div>
    <table><thead><tr><th>回</th><th>支払日</th><th>支払額</th><th>ボーナス</th><th>残価</th><th>利息</th><th>元金</th><th>残高</th></tr></thead><tbody>${rows}</tbody></table>
    <footer style="margin-top:14px;font-size:10px;color:#444">作成日時: ${new Date().toLocaleString('ja-JP')}</footer>
    <script>setTimeout(()=>window.print(), 50);<\/script>
    </body></html>`;
            }
            function openPDF() { const res = buildSchedule(getInputs()); const html = printableHTML(res); const w = window.open('', '_blank'); if (!w) { alert('ポップアップを許可してください'); return; } w.document.open(); w.document.write(html); w.document.close(); }

            /* ボタン */
            document.getElementById('run').addEventListener('click', () => { const res = buildSchedule(getInputs()); render(res); document.getElementById('detail').open = true; });
            document.getElementById('reset').addEventListener('click', () => {
                priceEl.value = 3000000; feesEl.value = 200000; downEl.value = 300000; tradeinEl.value = 0; rateEl.value = 3.9; monthsEl.value = 60;
                const now = new Date(); startMonthEl.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                bonusAmountEl.value = 0; bonusTypeEl.value = 'addon';
                ['bonusJan', 'bonusAug'].forEach(id => document.getElementById(id).checked = true);
                ['bonusFeb', 'bonusJul', 'bonusSep', 'bonusDec'].forEach(id => document.getElementById(id).checked = false);
                balloonYenEl.value = 0; balloonPctEl.value = 0; roundingEl.value = 'nearest'; balloonLast = 'yen';
                document.querySelector('input[name="mode"][value="annuity"]').checked = true;
                document.querySelector('#tbl tbody').innerHTML = '';
                ['k_principal', 'k_monthly', 'k_total', 'k_interest'].forEach(id => document.getElementById(id).textContent = '-');
                k_mode.textContent = '元利均等';
            });
            document.getElementById('print').addEventListener('click', openPDF);
            document.getElementById('export').addEventListener('click', () => { const res = buildSchedule(getInputs()); const csv = toCSV(res); const now = new Date(); const name = `auto-loan-schedule_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.csv`; download(name, csv); });

            /* 初期化：開始月=当月 */
            (function init() { const now = new Date(); startMonthEl.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; })();

            /* グラフタブ再描画 */
            const tabs = [document.getElementById('tab1'), document.getElementById('tab2')];
            tabs.forEach((t, i) => t.addEventListener('click', () => {
                tabs.forEach((x, j) => x.classList.toggle('active', j === i));
                panel1.style.display = i === 0 ? 'block' : 'none';
                panel2.style.display = i === 1 ? 'block' : 'none';
                if (i === 1) { const res = buildSchedule(getInputs()); drawChart(res.rows.map(r => r.balance)); }
            }));
        })();
    </script>

    <!-- 前回入力アシスト（localStorage） -->
    <script>
        (function () {
            const STORE_KEY = "autoLoanPRO:last-v2";
            const TARGETS = ["price", "fees", "down", "tradein", "rate", "months", "bonusAmount", "balloonYen", "balloonPct"];
            function saveState() {
                const s = {}; TARGETS.forEach(id => { const el = document.getElementById(id); if (el) s[id] = el.value; });
                localStorage.setItem(STORE_KEY, JSON.stringify(s));
            }
            function showAssist() {
                let s = {}; try { s = JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); } catch (_) { }
                TARGETS.forEach(id => {
                    const el = document.getElementById(id); if (!el) return;


                    // 既存 showAssist 内の該当部分をこの形に
                    const container = el.closest(".field") || el.parentNode;  // ← ここがポイント
                    let prev = container.querySelector(".assist");
                    if (!s[id]) { if (prev) prev.remove(); return; }
                    if (!prev) {
                        prev = document.createElement("small");
                        prev.className = "assist";
                        container.appendChild(prev);   // ← .field直下に置く
                    }
                    prev.textContent = "前回: " + s[id];
                    prev.onclick = () => {
                        el.value = s[id];
                        el.dispatchEvent(new Event("input", { bubbles: true }));
                        el.dispatchEvent(new Event("change", { bubbles: true }));
                    };

                });
            }
            TARGETS.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const handler = () => { saveState(); showAssist(); };
                el.addEventListener("change", handler);
                el.addEventListener("input", handler);   // ← 追加（任意）
            });

            window.addEventListener("load", showAssist);
        })();
    </script>

    <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(console.error);
    });
  }

  let deferredPrompt = null;
  const btn = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btn) btn.hidden = false;
  });
  if (btn) btn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.hidden = true;
  });

  // iOSは共有→ホーム画面に追加
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isIOS && !isStandalone) {
    // 必要ならガイドUIをここで表示
  }
</script>
<script>
  // --- Service Worker 登録 ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("/sw.js");
        // 初回はSWがコントロール外 → 次回ロードでbeforeinstallpromptが来ることがある
        console.log("SW:", reg);
      } catch (e) { console.error("SW register error:", e); }
    });
  }

  // --- インストール誘導（Chrome/Edge専用） ---
  let deferredPrompt = null;
  const installBtn = document.getElementById("btnInstall") || (() => {
    // ボタンが無ければ暫定で作る
    const b = document.createElement("button");
    b.id = "btnInstall";
    b.textContent = "インストール";
    b.hidden = true;
    b.style.cssText = "position:fixed;right:12px;bottom:12px;padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#111827;color:#e2e8f0;z-index:99999;cursor:pointer";
    document.body.appendChild(b);
    return b;
  })();

  // 1回でも「後で」にすると当面抑制される → ユーザー操作でのみ再表示
  window.addEventListener("beforeinstallprompt", (e) => {
    console.log("beforeinstallprompt fired");
    e.preventDefault();                 // 既定のバナーを止める
    deferredPrompt = e;                 // 後でprompt()するため保持
    installBtn.hidden = false;          // ボタンを表示
  });

  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();            // バナー表示（※ユーザー操作必須）
    const choice = await deferredPrompt.userChoice;
    console.log("PWA install choice:", choice.outcome);
    deferredPrompt = null;
    installBtn.hidden = true;           // 成否に関わらず一旦隠す（連打防止）
  });

  // --- iOSはボタンが出ない仕様 → ガイド表示（任意） ---
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isIOS && !isStandalone) {
    // ここで「共有 → ホーム画面に追加」ガイドを出すなら出す
    console.log("iOS: ホーム画面に追加を使用");
  }

  // --- 既にインストール済みならボタン隠す ---
  window.matchMedia('(display-mode: standalone)').addEventListener('change', e => {
    if (e.matches) installBtn.hidden = true;
  });
</script>

</body>

</html>
