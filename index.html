<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>自動車ローン シミュレーター（残価1〜99%対応）</title>
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;-webkit-user-select:none;user-select:none}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#fff}
  label{font-size:12px;color:#93c5fd}
  header{padding:16px;text-align:center;background:#111827}
  main{max-width:1100px;margin:auto;padding:16px}
  .panel{background:#111827;border:1px solid #1f2937;padding:16px;border-radius:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .btn{padding:10px 16px;border-radius:8px;border:1px solid #334155;background:#1f2937;color:#fff;cursor:pointer}
  .btn.primary{background:#4f46e5;border-color:#4f46e5}
  .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:16px}
  .card{background:#0b1220;padding:10px;border-radius:8px}
  .card h3{font-size:12px;color:#94a3b8;margin:0 0 4px}
  .card .val{font-size:20px;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:right;font-variant-numeric:tabular-nums}
  th{background:#0b1220;color:#93c5fd;position:sticky;top:0}
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  #months, #bonusTimes { max-height: 200px; overflow-y: auto; }
  .disabled-like{opacity:.6}
</style>
</head>
<body>
<header><h1>自動車ローン シミュレーター（残価1〜99%対応・ボーナスあり）</h1></header>

<main>
  <section class="panel">
    <div class="grid">
      <div><label for="price">車両価格（円）</label><input id="price" type="number" value="3000000"></div>
      <div><label for="down">頭金（円）</label><input id="down" type="number" value="500000"></div>
      <div><label for="rate">年利（%）</label><input id="rate" type="number" value="3.0" step="0.01" max="30"></div>

      <div>
        <label for="months">支払回数（ヶ月）</label>
        <select id="months"></select>
      </div>

      <div><label for="balloonPct">残価率（%）（1〜99）</label><input id="balloonPct" type="number" value="0"></div>
      <div><label for="balloonAmt">残価額（円）</label><input id="balloonAmt" type="number" value="0"></div>

      <div id="bonusAmtWrap"><label for="bonusAmt">ボーナス加算額（円）</label><input id="bonusAmt" type="number" value="0"></div>
      <div>
        <label for="bonusTimes">ボーナス年回数（0〜4）</label>
        <select id="bonusTimes"></select>
      </div>
    </div>

    <div style="margin-top:12px"><button id="calc" class="btn primary">計算する</button> <button id="download" class="btn" disabled>CSV</button></div>

    <div class="summary">
      <div class="card"><h3>借入額</h3><div id="loan" class="val">-</div></div>
      <div class="card"><h3>毎月返済</h3><div id="monthly" class="val">-</div></div>
      <div class="card"><h3>総支払額</h3><div id="total" class="val">-</div></div>
      <div class="card"><h3>利息総額</h3><div id="interest" class="val">-</div></div>
    </div>
  </section>

  <section class="panel"><div style="max-height:55vh;overflow:auto"><table><thead><tr><th>#</th><th>返済額</th><th>利息</th><th>元金</th><th>ボーナス</th><th>残高</th></tr></thead><tbody id="tbody"></tbody></table></div></section>
</main>

<script>
const fmt = new Intl.NumberFormat("ja-JP");
const $ = id => document.getElementById(id);

// セレクト生成
(function initSelectors(){
  const monthsSel = $("months");
  for(let i=1;i<=120;i++){
    const op=document.createElement("option");
    op.value=i; op.textContent=i;
    if(i===60) op.selected=true;
    monthsSel.appendChild(op);
  }
  const bonusSel = $("bonusTimes");
  for(let i=0;i<=4;i++){
    const op=document.createElement("option");
    op.value=i; op.textContent=i;
    if(i===2) op.selected=true;
    bonusSel.appendChild(op);
  }
})();

// ボーナス回数0→額無効化
function toggleBonus(){
  const times=+$("bonusTimes").value;
  const amtEl=$("bonusAmt"),wrap=$("bonusAmtWrap");
  if(times===0){amtEl.value=0;amtEl.disabled=true;wrap.classList.add("disabled-like");}
  else{amtEl.disabled=false;wrap.classList.remove("disabled-like");}
}
$("bonusTimes").addEventListener("change",toggleBonus);toggleBonus();

// 残価額↔残価率 連動
let syncing=false,lastSource="pct";
function getLoan(){return Math.max(+($("price").value||0)-+($("down").value||0),0);}
function syncFromPct(){
  if(syncing)return; syncing=true;
  const loan=getLoan(); let pct=+($("balloonPct").value||0);
  if(pct<1)pct=1; if(pct>99)pct=99;
  const amt=Math.floor(loan*pct/100);
  $("balloonPct").value=pct;
  $("balloonAmt").value=amt;
  syncing=false; lastSource="pct";
}
function syncFromAmt(){
  if(syncing)return; syncing=true;
  const loan=getLoan(); let amt=+($("balloonAmt").value||0);
  if(amt<0)amt=0; if(amt>loan)amt=loan;
  let pct=loan>0?(amt/loan*100):0;
  if(pct<1&&amt>0)pct=1;
  if(pct>99)pct=99;
  amt=Math.floor(loan*pct/100);
  $("balloonPct").value=Math.round(pct*100)/100;
  $("balloonAmt").value=amt;
  syncing=false; lastSource="amt";
}
function onLoanBaseChanged(){lastSource==="amt"?syncFromAmt():syncFromPct();}
$("balloonPct").addEventListener("input",syncFromPct);
$("balloonAmt").addEventListener("input",syncFromAmt);
$("price").addEventListener("input",onLoanBaseChanged);
$("down").addEventListener("input",onLoanBaseChanged);
syncFromPct();

// 計算
function compute(){
  const price=+($("price").value||0);
  const down=+($("down").value||0);
  const rate=Math.min(+($("rate").value||0),30);
  const months=Math.min(+($("months").value||0),120);
  let balloonPct=Math.min(Math.max(+($("balloonPct").value||0),1),99);
  let balloonAmt=+($("balloonAmt").value||0);
  const bonusTimes=Math.min(+($("bonusTimes").value||0),4);
  const bonusAmt=(bonusTimes===0)?0:+($("bonusAmt").value||0);

  const loan=Math.max(price-down,0),r=rate/100/12;
  const residual=balloonAmt,financed=Math.max(0,loan-residual);

  let monthly=0;
  if(r===0) monthly=financed/months;
  else{const pow=Math.pow(1+r,months);monthly=financed*(r*pow)/(pow-1);}

  let interval=0;
  if(bonusAmt>0&&bonusTimes>0) interval=Math.max(1,Math.round(12/bonusTimes));

  let bal=financed,totalPay=0,totalInt=0;
  const tb=$("tbody");tb.innerHTML="";
  for(let i=1;i<=months;i++){
    const interest=bal*r;let principal=Math.min(bal,monthly-interest);if(principal<0)principal=0;
    let bonus=0;if(interval&&(i%interval)===0){bonus=Math.min(bonusAmt,Math.max(0,bal-principal));}
    if(i===months) principal=Math.min(bal,principal);
    bal-=principal+bonus;const payment=principal+interest+bonus;
    totalPay+=payment;totalInt+=interest;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i}</td><td>${fmt.format(payment)}</td><td>${fmt.format(interest)}</td><td>${fmt.format(principal)}</td><td>${fmt.format(bonus)}</td><td>${fmt.format(Math.max(0,bal))}</td>`;
    tb.appendChild(tr);
  }
  let grandTotal=totalPay;
  if(residual>0){grandTotal+=residual;const tr=document.createElement("tr");tr.innerHTML=`<td>満期</td><td>${fmt.format(residual)}</td><td>—</td><td>—</td><td>—</td><td>0</td>`;tb.appendChild(tr);}
  $("loan").textContent=fmt.format(loan);
  $("monthly").textContent=fmt.format(monthly);
  $("total").textContent=fmt.format(grandTotal);
  $("interest").textContent=fmt.format(totalInt);
}
$("calc").addEventListener("click",compute);
compute();
</script>
</body>
</html>
