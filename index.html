<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>自動車ローン シミュレーター</title>
<meta name="theme-color" content="#0f172a" />
<link rel="apple-touch-icon" href="icon-180.png" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<style>
  :root{
    --bg:#0b1020; --card:#0e1426; --muted:#9aa4b2; --text:#e6ecf3;
    --line:#1f2a44; --primary:#6ea8fe; --radius:16px; --gap:14px; --shadow:0 12px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 120% -10%, rgba(34,211,238,.08), transparent 60%),radial-gradient(800px 600px at -10% 120%, rgba(79,134,247,.10), transparent 60%),#0b1020;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;-webkit-user-select:none;user-select:none}
  header{padding:28px 16px;text-align:center;background:linear-gradient(180deg, rgba(15,23,42,.6), transparent)}
  header h1{margin:.2rem 0;font-size:clamp(22px,3.2vw,30px)}
  header p{margin:.3rem 0 0;color:var(--muted)}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:var(--gap)}
  @media (max-width:980px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card-header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .card-header h2{margin:0;font-size:14px;color:#b8c3d6}
  .card-body{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
  .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  @media (max-width:720px){.col-4,.col-6{grid-column:span 12}}
  label{display:block;font-size:12px;color:#a5b4fc;margin:0 0 6px 2px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #243255;background:linear-gradient(180deg,#0c1326,#0c142a);color:var(--text);outline:none;font-variant-numeric:tabular-nums}
  input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(110,168,254,.15)}
  .seg{display:flex;gap:8px;background:#0b1224;border:1px solid var(--line);border-radius:12px;padding:6px}
  .seg input{display:none}
  .seg label{flex:1;text-align:center;padding:10px 8px;border-radius:10px;cursor:pointer;color:#cfe1ff}
  .seg input:checked+label{background:linear-gradient(180deg,rgba(110,168,254,.25),rgba(110,168,254,.15));border:1px solid #2b3a62}
  .actions .btn{padding:12px 16px;border-radius:12px;border:1px solid #29407a;background:linear-gradient(180deg,#173266,#142b5a);color:#dbe7ff;cursor:pointer}
  .actions .btn.primary{border-color:#3c6af0;background:linear-gradient(180deg,#3d6ffc,#2b59e9)}
  .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  @media (max-width:980px){.summary{grid-template-columns:repeat(2,1fr)}}
  .stat{background:#0a1328;border:1px solid var(--line);border-radius:14px;padding:14px}
  .stat h3{margin:0 0 6px;font-size:12px;color:#90a3bf}
  .stat .val{font-size:22px;font-weight:800}
  .table-wrap{max-height:56vh;overflow:auto;border-radius:14px;border:1px solid var(--line)}
  table{width:100%;border-collapse:collapse;font-size:14px;background:#0c1328}
  th,td{padding:10px 12px;border-bottom:1px solid #172446;text-align:right}
  th{position:sticky;top:0;background:#0b162f;color:#9ac4ff;z-index:1}
  td:first-child,th:first-child{text-align:center}
  tbody tr:nth-child(even){background:#0b152b}
  tbody tr:hover{background:#0f1c38}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  .disabled-like{opacity:.55}
</style>
</head>
<body>
<header>
  <h1>自動車ローン シミュレーター</h1>
  <p>残価＝車両価格基準／ローン金額＝支払い総額−頭金／ボーナス対応／CSV＋PDF出力</p>
</header>

<div class="container">
  <div class="layout">
    <!-- 入力 -->
    <section class="card">
      <div class="card-header"><h2>入力</h2></div>
      <div class="card-body">
        <div class="grid">
          <div class="col-4"><label>車両価格（円）</label><input id="price" type="number" value="3000000"></div>
          <div class="col-4"><label>支払い総額（円）</label><input id="totalCost" type="number" value="3300000"></div>
          <div class="col-4"><label>頭金（円）</label><input id="down" type="number" value="500000"></div>
          <div class="col-4"><label>ローン金額（円）<span style="font-size:11px;color:#9aa4b2">自動計算</span></label><input id="loanAmt" type="number" value="2800000" readonly></div>
          <div class="col-4"><label>年利（%）</label><input id="rate" type="number" value="3.0" max="30"></div>
          <div class="col-4"><label>支払回数（ヶ月）</label><select id="months"></select></div>
          <div class="col-4"><label>残価率（%）</label><input id="balloonPct" type="number" value="0"></div>
          <div class="col-4"><label>残価額（円）</label><input id="balloonAmt" type="number" value="0"></div>
          <div class="col-12"><label>ボーナス方式</label>
            <div class="seg"><input type="radio" id="modeAdd" name="bonusMode" value="add" checked><label for="modeAdd">加算額</label><input type="radio" id="modeTotal" name="bonusMode" value="total"><label for="modeTotal">総額</label></div>
          </div>
          <div class="col-4"><label>ボーナス年回数（0〜4）</label><select id="bonusTimes"></select></div>
          <div class="col-4" id="bonusAmtWrap"><label>ボーナス加算額（円）</label><input id="bonusAmt" type="number" value="0"></div>
          <div class="col-4" id="bonusTotalWrap"><label>ボーナス月総額（円）</label><input id="bonusTotal" type="number" value="0"></div>
          <div class="col-12 actions"><button id="calc" class="btn primary">計算する</button><button id="download" class="btn" disabled>CSV</button><button id="pdf" class="btn" disabled>PDF</button></div>
        </div>
      </div>
    </section>
    <!-- 出力 -->
    <section class="card">
      <div class="card-header"><h2>結果</h2></div>
      <div class="card-body">
        <div class="summary">
          <div class="stat"><h3>借入額</h3><div id="loan" class="val">-</div></div>
          <div class="stat"><h3>毎月返済</h3><div id="monthly" class="val">-</div></div>
          <div class="stat"><h3>総支払額</h3><div id="total" class="val">-</div></div>
          <div class="stat"><h3>利息総額</h3><div id="interest" class="val">-</div></div>
        </div>
        <div class="table-wrap"><table><thead><tr><th>#</th><th>返済額</th><th>利息</th><th>元金</th><th>ボーナス</th><th>残高</th></tr></thead><tbody id="tbody"></tbody></table></div>
      </div>
    </section>
  </div>
</div>

<!-- PDF用ライブラリ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const fmt=new Intl.NumberFormat("ja-JP");const $=id=>document.getElementById(id);
/* セレクト生成 */(()=>{for(let i=1;i<=120;i++){const op=document.createElement("option");op.value=i;op.textContent=i;if(i===60)op.selected=true;$("months").appendChild(op);}for(let i=0;i<=4;i++){const op=document.createElement("option");op.value=i;op.textContent=i;if(i===2)op.selected=true;$("bonusTimes").appendChild(op);}})();
/* フォーカス青反転 */document.querySelectorAll("input[type=number]").forEach(inp=>{inp.addEventListener("focus",()=>inp.select());inp.addEventListener("mousedown",e=>{e.preventDefault();inp.select();});});
/* ローン金額自動 */function recalcLoanAmt(){const total=+($("totalCost").value||0),down=+($("down").value||0);$("loanAmt").value=Math.max(total-down,0);}["totalCost","down"].forEach(id=>$(id).addEventListener("input",recalcLoanAmt));
/* 残価連動 */let last="pct";function syncPct(){const price=+($("price").value||0);let pct=+($("balloonPct").value||0);if(pct<=0){$("balloonPct").value=0;$("balloonAmt").value=0;}else{if(pct<1)pct=1;if(pct>99)pct=99;$("balloonPct").value=pct;$("balloonAmt").value=Math.floor(price*pct/100);}last="pct";}function syncAmt(){const price=+($("price").value||0);let amt=+($("balloonAmt").value||0);if(amt<=0){$("balloonAmt").value=0;$("balloonPct").value=0;}else{if(amt>price)amt=price;let pct=(amt/price*100);if(pct<1)pct=1;if(pct>99)pct=99;$("balloonPct").value=Math.round(pct);$("balloonAmt").value=Math.floor(price*pct/100);}last="amt";}$("balloonPct").addEventListener("input",syncPct);$("balloonAmt").addEventListener("input",syncAmt);$("price").addEventListener("input",()=>{last==="amt"?syncAmt():syncPct();});
/* ボーナスUI */function toggleBonus(){const times=+($("bonusTimes").value||0),mode=document.querySelector('input[name="bonusMode"]:checked').value;const amt=$("bonusAmt"),tot=$("bonusTotal");amt.disabled=mode!=="add"||times===0;tot.disabled=mode!=="total"||times===0;}["bonusTimes"].forEach(id=>$(id).addEventListener("change",toggleBonus));document.querySelectorAll('input[name="bonusMode"]').forEach(r=>r.addEventListener("change",toggleBonus));
/* 計算 */$("calc").addEventListener("click",compute);function compute(){recalcLoanAmt();const loan=+($("loanAmt").value||0),rate=Math.min(+($("rate").value||0),30),months=+($("months").value||0),balloonAmt=+($("balloonAmt").value||0),bonusTimes=+($("bonusTimes").value||0),mode=document.querySelector('input[name="bonusMode"]:checked').value,bonusAmt=+($("bonusAmt").value||0),bonusTotal=+($("bonusTotal").value||0);const r=rate/100/12;const effectiveResidual=Math.min(balloonAmt,loan);const financed=Math.max(loan-effectiveResidual,0);let monthly;if(r===0)monthly=financed/months;else{const pow=Math.pow(1+r,months);monthly=financed*(r*pow)/(pow-1);}let bal=financed,totalPay=0,totalInt=0,tb=$("tbody");tb.innerHTML="";const interval=bonusTimes>0?Math.max(1,Math.round(12/bonusTimes)):0;for(let i=1;i<=months;i++){const interest=bal*r;let basePay=monthly,bonus=0,isBonus=interval&&(i%interval)===0;if(isBonus){if(mode==="add"){bonus=bonusAmt;}else{basePay=bonusTotal;}}const pay=(mode==="add")?(basePay+bonus):basePay;let prin=Math.min(bal,pay-interest);if(prin<0)prin=0;bal-=prin;totalPay+=pay;totalInt+=interest;tb.innerHTML+=`<tr><td>${i}</td><td>${fmt.format(pay)}</td><td>${fmt.format(interest)}</td><td>${fmt.format(prin)}</td><td>${fmt.format(isBonus?(mode==="add"?bonus:pay-monthly):0)}</td><td>${fmt.format(Math.max(0,bal))}</td></tr>`;}let grand=totalPay;if(effectiveResidual>0){grand+=effectiveResidual;tb.innerHTML+=`<tr><td>満期</td><td>${fmt.format(effectiveResidual)}</td><td>—</td><td>—</td><td>—</td><td>0</td></tr>`;}$("loan").textContent=fmt.format(loan);$("monthly").textContent=fmt.format(Math.round(monthly));$("total").textContent=fmt.format(Math.round(grand));$("interest").textContent=fmt.format(Math.round(totalInt));
  // CSV
  const rows=[["#","返済額","利息","元金","ボーナス","残高"]];document.querySelectorAll("#tbody tr").forEach(tr=>{rows.push([...tr.children].map(td=>td.textContent.replace(/,/g,"")));});const csv=rows.map(r=>r.join(",")).join("\n");const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);$("download").disabled=false;$("download").onclick=()=>{const a=document.createElement("a");a.href=url;a.download="car_loan.csv";a.click();};
  // PDF
  $("pdf").disabled=false;$("pdf").onclick=async()=>{const canvas=await html2canvas(document.querySelector(".card:nth-child(2)"),{scale:2,backgroundColor:"#fff"});const {jsPDF}=window.jspdf;const pdf=new jsPDF("p","mm","a4");const img=canvas.toDataURL("image/png");const w=pdf.internal.pageSize.getWidth();const h=canvas.height*w/canvas.width/3.78;pdf.addImage(img,"PNG",0,0,w,h);pdf.save("car_loan.pdf");};
}
</script>
</body>
</html>
