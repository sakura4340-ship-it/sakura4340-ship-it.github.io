<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼PROï¼ˆãƒ•ãƒ«HTMLãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OKï¼‰</title>
<meta name="theme-color" content="#0f172a" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%230ea5e9' d='M8 36a4 4 0 0 1 4-4h40a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4z'/%3E%3Ccircle cx='20' cy='50' r='6' fill='%23e2e8f0'/%3E%3Ccircle cx='44' cy='50' r='6' fill='%23e2e8f0'/%3E%3Cpath fill='%231f2937' d='M9 34c2-7 8-12 15-12h16c7 0 13 5 15 12z'/%3E%3C/svg%3E" />
<style>
  :root{
    --bg:#0b1020; --surface:#0e1426; --muted:#9aa4b2; --text:#e6ecf3;
    --line:#1f2a44; --accent:#0ea5e9; --accent-2:#22d3ee;
    --danger:#ef4444; --ok:#22c55e; --warning:#f59e0b;
    --radius:16px; --gap:14px; --shadow:0 14px 45px rgba(0,0,0,.38);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:
      radial-gradient(1200px 800px at 120% -10%, rgba(34,211,238,.08), transparent 60%),
      radial-gradient(1000px 600px at -10% 110%, rgba(14,165,233,.10), transparent 60%),
      var(--bg);
    font: 15px/1.6 system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  }
  header{ padding: 24px 18px 10px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .logo{ width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); display:grid; place-items:center; box-shadow:var(--shadow)}
  h1{margin:0; font-size:20px; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12.5px; margin-top:2px}
  main{ padding: 0 18px 28px; display:grid; grid-template-columns: 460px 1fr; gap:20px; }
  @media (max-width: 980px){ main{grid-template-columns: 1fr} }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 18%); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
  .card h2{ margin:0; padding:14px 16px; font-size:15px; border-bottom:1px dashed var(--line); color:#cbd5e1 }
  .card .content{ padding: 14px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px }
  .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-bottom:12px }
  .field{ display:flex; flex-direction:column; gap:6px; min-width:0 }
  .field label{ font-size:12.5px; color:var(--muted) }
  .field input, .field select{ background:#0a1124; border:1px solid #1b2743; color:#e6ecf3; border-radius:12px; padding:12px 12px; outline:none; width:100%; max-width:100%; min-width:0 }
  .field input[type="number"]{ text-align:right }
  .hint{ font-size:12px; color:#7b879a }
  .muted{ color: var(--muted) }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; padding: 0 14px 14px }
  button{ appearance:none; border:none; cursor:pointer; background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#001018; font-weight:700; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow) }
  button.secondary{ background:#0a1124; color:#e6ecf3; border:1px solid #1b2743; font-weight:600; }
  .tabs{ display:flex; gap:8px; padding: 10px 14px 0; flex-wrap:wrap }
  .tab{ padding:8px 10px; border:1px solid #1b2743; border-radius:999px; font-size:12.5px; color:#9fb3d1; cursor:pointer }
  .tab.active{ background:#0a1124 }
  .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; padding:14px; }
  .tile{ background:#0a1124; border:1px solid #1b2743; border-radius:14px; padding:12px }
  .tile .label{ font-size:12px; color:#9aa4b2 }
  .tile .value{ font-size:22px; font-weight:800; margin-top:4px }
  .tile .subv{ font-size:12px; color:#7b879a; margin-top:2px }
  .schedule{ padding: 6px 14px 14px }
  details{ border-top:1px dashed var(--line); }
  details summary{ padding:12px 0; cursor:pointer; color:#cbd5e1 }
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  th,td{ border-bottom:1px solid #12203f; padding:8px 8px; text-align:right; white-space:nowrap }
  th{ color:#9fb3d1; font-weight:600; position:sticky; top:0; background:#0d1427 }
  td:first-child, th:first-child{ text-align:left }
  .footer{ padding:10px 14px 18px; color:#7b879a; font-size:12px }
  .chartWrap{ padding: 0 14px 16px }
  canvas{ width:100%; height:260px; display:block; background:#0a1124; border:1px solid #1b2743; border-radius:12px }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
  .chip{ padding:6px 8px; border:1px solid #1b2743; border-radius:999px; font-size:12px; color:#9fb3d1 }
  .mode{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .mode label{ display:flex; align-items:center; gap:6px; border:1px solid #1b2743; border-radius:999px; padding:6px 10px; font-size:12.5px; color:#9fb3d1 }

  /* Responsive fixes */
  @media (max-width: 700px){
    .row, .row3{ grid-template-columns: 1fr }
    .grid2{ grid-template-columns: 1fr }
  }

  /* Hide number steppers */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
  input[type=number]{ -moz-appearance:textfield; appearance:textfield }
</style>
</head>
<body>
<header>
  <div class="logo">ğŸš—</div>
  <div>
    <h1>è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼PRO</h1>
    <div class="sub">å…ƒåˆ©å‡ç­‰ï¼å…ƒé‡‘å‡ç­‰ãƒ»ãƒœãƒ¼ãƒŠã‚¹ã€ŒåŠ ç®— or ç·é¡æŒ‡å®šã€ãƒ»æ®‹ä¾¡ï¼…ï¼å††ï¼ˆç›¸äº’é€£å‹•ï¼‰ãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º</div>
  </div>
</header>

<main>
  <section class="card" id="inputs">
    <h2>å…¥åŠ›ï¼ˆæ—¥æœ¬å›½å†…å‘ã‘ï¼‰</h2>
    <div class="content">
      <div class="row">
        <div class="field">
          <label>è»Šä¸¡æœ¬ä½“ä¾¡æ ¼ <span class="muted">ï¼ˆç¨è¾¼æƒ³å®šï¼‰</span></label>
          <input type="number" id="price" value="3000000" min="0" step="1000" autofocus>
        </div>
        <div class="field">
          <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»è«¸è²»ç”¨</label>
          <input type="number" id="fees" value="200000" min="0" step="1000">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>é ­é‡‘</label>
          <input type="number" id="down" value="300000" min="0" step="1000">
        </div>
        <div class="field">
          <label>ä¸‹å–ã‚Šï¼ˆå·®å¼•å¾Œï¼‰</label>
          <input type="number" id="tradein" value="0" min="0" step="1000">
        </div>
      </div>

      <div class="row3">
        <div class="field">
          <label>å®Ÿè³ªå¹´ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" id="rate" value="3.9" min="0" step="0.01">
        </div>
        <div class="field">
          <label>è¿”æ¸ˆå›æ•°ï¼ˆæœˆï¼‰</label>
          <input type="number" id="months" value="60" min="1" step="1">
        </div>
        <div class="field">
          <label>é–‹å§‹æœˆ <span class="muted">ï¼ˆåˆå›å¼•è½æƒ³å®šï¼‰</span></label>
          <input type="month" id="startMonth">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ãƒœãƒ¼ãƒŠã‚¹é¡</label>
          <input type="number" id="bonusAmount" value="0" min="0" step="1000">
          <div style="margin-top:6px">
            <select id="bonusType">
              <option value="addon" selected>åŠ ç®—ï¼ˆé€šå¸¸æœˆã«ä¸Šä¹—ã›ï¼‰</option>
              <option value="total">ç·é¡æŒ‡å®šï¼ˆãã®æœˆã®æ”¯æ‰•ç·é¡ï¼‰</option>
            </select>
          </div>
          <div class="chips" style="margin-top:8px">
            <label class="chip"><input type="checkbox" id="bonusJan" checked> 1æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusJul" checked> 7æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusJun"> 6æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusDec"> 12æœˆ</label>
          </div>
          <div class="hint">ã€ŒåŠ ç®—ã€ï¼é€šå¸¸è¿”æ¸ˆã«ä¸Šä¹—ã›ï¼ã€Œç·é¡æŒ‡å®šã€ï¼ãƒœãƒ¼ãƒŠã‚¹æœˆã®ç·æ”¯æ‰•é¡ã‚’å›ºå®šï¼ˆæœ€çµ‚å›ã¯æ®‹ä¾¡ã‚’å«ã‚€ï¼‰ã€‚</div>
        </div>
        <div class="field">
          <label>æ®‹ä¾¡è¨­å®š</label>
          <div class="grid2">
            <input type="number" id="balloonYen" value="0" min="0" step="1000" placeholder="æ®‹ä¾¡ï¼ˆå††ï¼‰">
            <input type="number" id="balloonPct" value="0" min="0" step="0.1" placeholder="æ®‹ä¾¡ï¼ˆï¼…ï¼‰">
          </div>
          <div class="hint" id="balloonHint">
            æ®‹ä¾¡ç‡ã®åŸºæº–ï¼š<strong>è»Šä¸¡æœ¬ä½“ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</strong>ã«å¯¾ã—ã¦%ã‚’æ›ã‘ã¾ã™ã€‚ä¸Šé™ã¯å€Ÿå…¥å…ƒé‡‘ã®90%ã€‚
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ç«¯æ•°å‡¦ç†</label>
          <select id="rounding">
            <option value="none">ã—ãªã„ï¼ˆå††å˜ä½ï¼‰</option>
            <option value="down">æ¯å›ï¼šåˆ‡ã‚Šæ¨ã¦</option>
            <option value="nearest" selected>æ¯å›ï¼šå››æ¨äº”å…¥</option>
            <option value="up">æ¯å›ï¼šåˆ‡ã‚Šä¸Šã’</option>
          </select>
        </div>
        <div class="field">
          <label>è¿”æ¸ˆæ–¹å¼</label>
          <div class="mode">
            <label><input type="radio" name="mode" value="annuity" checked> å…ƒåˆ©å‡ç­‰</label>
            <label><input type="radio" name="mode" value="equal_principal"> å…ƒé‡‘å‡ç­‰</label>
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="run">è¨ˆç®—ã™ã‚‹</button>
      <button id="reset" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="print" class="secondary">å°åˆ·ï¼PDF</button>
      <button id="export" class="secondary">CSVæ›¸ãå‡ºã—</button>
    </div>
  </section>

  <section class="card">
    <div class="tabs">
      <div class="tab active" id="tab1">çµæœã‚µãƒãƒªãƒ¼</div>
      <div class="tab" id="tab2">æ®‹é«˜ã‚°ãƒ©ãƒ•</div>
    </div>
    <div id="panel1">
      <div class="kpi">
        <div class="tile">
          <div class="label">å€Ÿå…¥é‡‘é¡ï¼ˆå…ƒé‡‘ï¼‰</div>
          <div id="k_principal" class="value">-</div>
          <div class="subv">ï¼ˆç·æ”¯æ‰• - åˆ©æ¯ - æ‰‹å…ƒæ”¯æ‰•ï¼‰</div>
        </div>
        <div class="tile">
          <div class="label">æ¯æœˆã®åŸºæœ¬è¿”æ¸ˆï¼ˆãƒœãƒ¼ãƒŠã‚¹é™¤ãï¼‰</div>
          <div id="k_monthly" class="value">-</div>
          <div class="subv"><span id="k_mode">å…ƒåˆ©å‡ç­‰</span>ãƒ»é¸æŠæœˆã¯ãƒœãƒ¼ãƒŠã‚¹åæ˜ </div>
        </div>
        <div class="tile">
          <div class="label">ç·æ”¯æ‰•é¡</div>
          <div id="k_total" class="value">-</div>
          <div class="subv">ã†ã¡åˆ©æ¯ï¼š<span id="k_interest">-</span></div>
        </div>
      </div>
      <div class="schedule">
        <details id="detail">
          <summary>è¿”æ¸ˆäºˆå®šè¡¨ã‚’é–‹ã</summary>
          <div style="overflow:auto; max-height:55vh; margin-top:10px">
            <table id="tbl">
              <thead>
                <tr>
                  <th>å›</th><th>æ”¯æ‰•æ—¥</th><th>æ”¯æ‰•é¡</th><th>ã†ã¡ãƒœãƒ¼ãƒŠã‚¹</th><th>ã†ã¡æ®‹ä¾¡</th>
                  <th>åˆ©æ¯</th><th>å…ƒé‡‘</th><th>æ®‹é«˜</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
      <div class="footer" id="testStatus"></div>
    </div>
    <div id="panel2" style="display:none">
      <div class="chartWrap"><canvas id="chart" width="800" height="260" aria-label="æ®‹é«˜ã®æ¨ç§»"></canvas></div>
      <div class="footer">æ®‹é«˜ã‚°ãƒ©ãƒ•ï¼šç¸¦è»¸ï¼æ®‹é«˜ï¼ˆå††ï¼‰ã€æ¨ªè»¸ï¼å›æ•°ï¼ˆ1ã€œNï¼‰ã€‚</div>
    </div>
  </section>
</main>

<script>
(function(){
  const yen = n => n.toLocaleString('ja-JP', {maximumFractionDigits:0});
  const nextMonth = d => new Date(d.getFullYear(), d.getMonth()+1, 1);

  // focus-friendly numeric inputs
  function enhanceNumericInputs(){
    const nums = Array.from(document.querySelectorAll('#inputs input[type="number"]'));
    nums.forEach((el)=>{
      el.setAttribute('inputmode','decimal');
      el.setAttribute('autocomplete','off');
      el.addEventListener('focus', e=>{ e.target.select(); });
      el.addEventListener('mousedown', e=>{ if(document.activeElement!==e.target){ e.preventDefault(); e.target.focus(); e.target.select(); } });
      el.addEventListener('wheel', e=>{ e.preventDefault(); }, {passive:false});
      el.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          const focusables = Array.from(document.querySelectorAll('#inputs input, #inputs select, #inputs button'));
          const i = focusables.indexOf(e.target);
          const next = focusables[i+1] || focusables[0];
          next.focus(); if(next.select) next.select();
          e.preventDefault();
        }
      });
    });
  }

  function roundingMode(val, mode){
    if(mode==='down') return Math.floor(val);
    if(mode==='up') return Math.ceil(val);
    if(mode==='nearest') return Math.round(val);
    return Math.round(val); // å††å˜ä½å›ºå®š
  }

  // Elements
  const priceEl = document.getElementById('price');
  const feesEl = document.getElementById('fees');
  const downEl = document.getElementById('down');
  const tradeinEl = document.getElementById('tradein');
  const rateEl = document.getElementById('rate');
  const monthsEl = document.getElementById('months');
  const startMonthEl = document.getElementById('startMonth');
  const bonusAmountEl = document.getElementById('bonusAmount');
  const bonusJanEl = document.getElementById('bonusJan');
  const bonusJulEl = document.getElementById('bonusJul');
  const bonusJunEl = document.getElementById('bonusJun');
  const bonusDecEl = document.getElementById('bonusDec');
  const balloonYenEl = document.getElementById('balloonYen');
  const balloonPctEl = document.getElementById('balloonPct');
  const roundingEl = document.getElementById('rounding');

  const k_principal = document.getElementById('k_principal');
  const k_monthly = document.getElementById('k_monthly');
  const k_total = document.getElementById('k_total');
  const k_interest = document.getElementById('k_interest');
  const k_mode = document.getElementById('k_mode');

  const chart = document.getElementById('chart');
  const panel1 = document.getElementById('panel1');
  const panel2 = document.getElementById('panel2');

  // --- Bases ---
  function loanPrincipal(){
    const price = +priceEl.value||0; const fees = +feesEl.value||0; const down = +downEl.value||0; const tradein = +tradeinEl.value||0;
    return Math.max(0, price + fees - down - tradein);
  }
  function vehicleBasePrice(){ // æ®‹ä¾¡ç‡ã®åŸºæº–ï¼šç¨è¾¼ã®è»Šä¸¡æœ¬ä½“ä¾¡æ ¼
    return +priceEl.value || 0;
  }

  // --- Residual value bi-directional sync ---
  let balloonLast = 'yen'; // or 'pct'
  let syncing = false;
  function clampBalloonYen(y){ const p = loanPrincipal(); return Math.max(0, Math.min(y, p*0.9)); }
  function clampBalloonPct(pc){ return Math.max(0, Math.min(pc, 90)); }

  // NOTE: during typing, never overwrite the field being edited.
  function syncFromPct(){
    if(syncing) return; syncing = true;
    const base = vehicleBasePrice(); // ç¨è¾¼æœ¬ä½“ãŒåŸºæº–
    const rawPct = +balloonPctEl.value || 0;
    const effPct = clampBalloonPct(rawPct);
    const idealY = Math.round(base * effPct/100 / 1000) * 1000; // åƒå††ä¸¸ã‚
    const y = clampBalloonYen(idealY); // ãƒ­ãƒ¼ãƒ³å…ƒé‡‘90%ä¸Šé™
    balloonYenEl.value = String(y|0); // å¯¾å‘æ¬„ã®ã¿æ›´æ–°
    document.getElementById('balloonHint').textContent = `åŸºæº–=è»Šä¸¡æœ¬ä½“: Â¥${Math.round(base).toLocaleString('ja-JP')}ï½œå…¥åŠ› ${rawPct}% â†’ è¨ˆç®— ${effPct.toFixed(1)}% â†’ æ®‹ä¾¡ â‰ˆ Â¥${y.toLocaleString('ja-JP')}ï¼ˆä¸Šé™=å…ƒé‡‘90%ï¼‰`;
    balloonLast='pct'; syncing=false;
  }
  function commitPct(){
    const effPct = clampBalloonPct(+balloonPctEl.value || 0);
    balloonPctEl.value = effPct.toFixed(1);
    syncFromPct();
  }

  function syncFromYen(){
    if(syncing) return; syncing = true;
    const base = vehicleBasePrice();
    const rawY = +balloonYenEl.value || 0;
    const effY = clampBalloonYen(rawY);
    const pct = base>0 ? (effY/base)*100 : 0;
    balloonPctEl.value = clampBalloonPct(pct).toFixed(1); // å¯¾å‘æ¬„ã®ã¿æ›´æ–°
    document.getElementById('balloonHint').textContent = `åŸºæº–=è»Šä¸¡æœ¬ä½“: Â¥${Math.round(base).toLocaleString('ja-JP')}ï½œå…¥åŠ› Â¥${rawY.toLocaleString('ja-JP')} â†’ è¨ˆç®—å€¤ Â¥${effY.toLocaleString('ja-JP')}ï¼ˆç‡ â‰ˆ ${clampBalloonPct(pct).toFixed(1)}%ï¼ä¸Šé™=å…ƒé‡‘90%ï¼‰`;
    balloonLast='yen'; syncing=false;
  }
  function commitYen(){
    const effY = clampBalloonYen(+balloonYenEl.value || 0);
    balloonYenEl.value = String(effY|0);
    syncFromYen();
  }

  balloonPctEl.addEventListener('input', syncFromPct);
  balloonPctEl.addEventListener('change', commitPct);
  balloonPctEl.addEventListener('blur', commitPct);
  balloonYenEl.addEventListener('input', syncFromYen);
  balloonYenEl.addEventListener('change', commitYen);
  balloonYenEl.addEventListener('blur', commitYen);

  function getInputs(){
    const price = +priceEl.value||0; const fees = +feesEl.value||0; const down = +downEl.value||0; const tradein = +tradeinEl.value||0;
    const rateY = +rateEl.value||0; const months = Math.max(1, (+monthsEl.value|0));
    const startMonthStr = startMonthEl.value; const startDate = startMonthStr ? new Date(startMonthStr+'-01') : new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const bonusAmount = +bonusAmountEl.value||0; const bonusType = (document.getElementById('bonusType')||{value:'addon'}).value;
    const bonusMonths = []; if(bonusJanEl.checked) bonusMonths.push(0); if(bonusJulEl.checked) bonusMonths.push(6); if(bonusJunEl.checked) bonusMonths.push(5); if(bonusDecEl.checked) bonusMonths.push(11);
    const balloonYen = clampBalloonYen(+balloonYenEl.value||0); const balloonPct = clampBalloonPct(+balloonPctEl.value||0);
    const rounding = roundingEl.value; const mode = document.querySelector('input[name="mode"]:checked').value;
    return {price, fees, down, tradein, rateY, months, startDate, bonusAmount, bonusType, bonusMonths, balloonPct, balloonYen, rounding, mode, balloonLast};
  }

  function resolveBalloon(principal, last, pct, yen){
    const base = vehicleBasePrice(); // ç‡â†’å††ã¯è»Šä¸¡æœ¬ä½“ãƒ™ãƒ¼ã‚¹
    const fromPct = base * (pct/100);
    const candidate = (last==='pct') ? fromPct : yen;
    return Math.max(0, Math.min(candidate, principal*0.9));
  }

  function buildSchedule(inp){
    const r = inp.rateY/100/12;
    const gross = inp.price + inp.fees;
    const principal = Math.max(0, gross - inp.down - inp.tradein);
    const balloon = resolveBalloon(principal, inp.balloonLast, inp.balloonPct, inp.balloonYen);
    const bonusSet = new Set(inp.bonusMonths);
    const isTotal = inp.bonusType==='total';

    if(inp.mode==='annuity'){
      let lo = 0, hi = Math.max(1, principal / inp.months);
      const feasible = base => {
        let bal = principal; let d = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
        for(let i=0;i<inp.months;i++){
          const isBonus = bonusSet.has(d.getMonth());
          let pay = (isBonus ? (isTotal ? inp.bonusAmount : base + inp.bonusAmount) : base) + (i===inp.months-1? balloon:0);
          const interest = bal * r; const prin = Math.max(0, pay - interest); bal -= prin; d = nextMonth(d);
        }
        return bal <= 0;
      };
      while(!feasible(hi)) hi *= 1.6, hi = Math.min(hi, principal*2 + 1e6);
      for(let k=0;k<64;k++){ const mid=(lo+hi)/2; feasible(mid)? hi=mid: lo=mid; }
      const baseMonthly = hi;

      const rows = []; let bal = principal, totalPay=0, totalInt=0, totalBonus=0; let d = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
      for(let i=0;i<inp.months;i++){
        const isBonus = bonusSet.has(d.getMonth());
        const bonusDisp = isBonus && !isTotal ? inp.bonusAmount : 0;
        let pay = (isBonus ? (isTotal ? inp.bonusAmount : baseMonthly + inp.bonusAmount) : baseMonthly) + (i===inp.months-1? balloon:0);
        const interest = bal * r; let prin = Math.max(0, pay - interest);
        pay = roundingMode(pay, inp.rounding); const adjust = pay - (interest + prin); prin += adjust;
        if(i===inp.months-1){ prin = bal; pay = roundingMode(interest + prin, inp.rounding); }
        bal = Math.max(0, bal - prin);
        totalPay += pay; totalInt += Math.max(0, interest); totalBonus += bonusDisp;
        rows.push({ idx:i+1, date:new Date(d), pay, bonus: bonusDisp, balloon:(i===inp.months-1? balloon:0), interest, principal: prin, balance: bal }); d = nextMonth(d);
      }
      return { mode:'å…ƒåˆ©å‡ç­‰', principal, baseMonthly: roundingMode(baseMonthly, inp.rounding), totalPay: roundingMode(totalPay, 'nearest'), totalInterest: Math.round(totalInt), totalBonus, balloon, rows };

    } else {
      const rows = []; let bal = principal, totalPay=0, totalInt=0, totalBonus=0; let d = new Date(inp.startDate.getFullYear(), inp.startDate.getMonth(), 1);
      const monthlyPrincipal = Math.max(0, (principal - balloon) / inp.months); let firstBaseMonthly = 0;
      for(let i=0;i<inp.months;i++){
        const isBonus = bonusSet.has(d.getMonth()); const interest = bal * r; let bonusDisp = 0; let prin = (i===inp.months-1 ? bal : monthlyPrincipal);
        let targetPay;
        if(isBonus && isTotal){ targetPay = inp.bonusAmount + (i===inp.months-1? balloon:0); }
        else { bonusDisp = isBonus ? inp.bonusAmount : 0; targetPay = prin + interest + bonusDisp + (i===inp.months-1? balloon:0); }
        let pay = roundingMode(targetPay, inp.rounding);
        prin = pay - interest - (i===inp.months-1? balloon:0) - (isBonus && !isTotal ? bonusDisp : 0);
        if(i===inp.months-1){ prin = bal; pay = roundingMode(interest + prin + (isBonus && !isTotal ? bonusDisp:0) + (i===inp.months-1? balloon:0), inp.rounding); }
        bal = Math.max(0, bal - prin);
        totalPay += pay; totalInt += Math.max(0, interest); totalBonus += bonusDisp;
        if(i===0) firstBaseMonthly = roundingMode(prin + interest, inp.rounding);
        rows.push({ idx:i+1, date:new Date(d), pay, bonus: bonusDisp, balloon:(i===inp.months-1? balloon:0), interest, principal: prin, balance: bal }); d = nextMonth(d);
      }
      return { mode:'å…ƒé‡‘å‡ç­‰', principal, baseMonthly: firstBaseMonthly, totalPay: roundingMode(totalPay, 'nearest'), totalInterest: Math.round(totalInt), totalBonus, balloon, rows };
    }
  }

  function fmtDate(d){ const y = d.getFullYear(), m = (d.getMonth()+1).toString().padStart(2,'0'); return `${y}/${m}`; }

  function render(res){
    k_principal.textContent = `Â¥${yen(res.principal)}`;
    k_monthly.textContent = `Â¥${yen(res.baseMonthly)}`;
    k_total.textContent = `Â¥${yen(res.totalPay)}`;
    k_interest.textContent = `Â¥${yen(res.totalInterest)}`;
    k_mode.textContent = res.mode;

    const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
    for(const r of res.rows){
      const tr = document.createElement('tr');
      const cells = [ r.idx, fmtDate(r.date), `Â¥${yen(Math.round(r.pay))}`, r.bonus? `Â¥${yen(r.bonus)}`: 'â€”', r.balloon? `Â¥${yen(r.balloon)}`: 'â€”', `Â¥${yen(Math.round(r.interest))}`, `Â¥${yen(Math.round(r.principal))}`, `Â¥${yen(Math.round(r.balance))}` ];
      for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }
      tb.appendChild(tr);
    }

    drawChart(res.rows.map(r=>r.balance));
  }

  function toCSV(res){
    const header = ['å›','æ”¯æ‰•å¹´æœˆ','æ”¯æ‰•é¡','ãƒœãƒ¼ãƒŠã‚¹','æ®‹ä¾¡','åˆ©æ¯','å…ƒé‡‘','æ®‹é«˜'];
    const lines = [header.join(',')];
    for(const r of res.rows){ lines.push([ r.idx, fmtDate(r.date), Math.round(r.pay), r.bonus, r.balloon, Math.round(r.interest), Math.round(r.principal), Math.round(r.balance) ].join(',')); }
    const meta = [ ['è¿”æ¸ˆæ–¹å¼', res.mode], ['å€Ÿå…¥å…ƒé‡‘', res.principal], ['æ¯æœˆåŸºæœ¬è¿”æ¸ˆ(æ¦‚ç®—)', res.baseMonthly], ['ç·æ”¯æ‰•é¡', res.totalPay], ['ç·åˆ©æ¯', res.totalInterest], ['æ®‹ä¾¡', res.balloon] ].map(a=>a[0]+','+a[1]).join('\n');
    return `ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥,è¿”æ¸ˆäºˆå®šè¡¨\n${lines.join('\n')}\n\nã‚µãƒãƒªãƒ¼\n${meta}`;
  }

  function download(name, text){ const blob = new Blob([text], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 2000); }

  function drawChart(values){
    const c = chart; const ctx = c.getContext('2d'); const W = c.width, H = c.height; ctx.clearRect(0,0,W,H);
    const padL=50, padR=16, padT=12, padB=26; const w = W - padL - padR, h = H - padT - padB; const n = values.length;
    const maxV = Math.max(...values), minV = Math.min(...values); const y = v => padT + h - (h*(v - minV)/(maxV - minV || 1)); const x = i => padL + (w*(i)/(Math.max(1,n-1)));
    ctx.strokeStyle = '#1b2743'; ctx.lineWidth = 1; ctx.beginPath(); for(let k=0;k<=4;k++){ const gy = padT + h*k/4; ctx.moveTo(padL, gy); ctx.lineTo(W-padR, gy); } ctx.stroke();
    ctx.fillStyle = '#9fb3d1'; ctx.font = '12px system-ui, sans-serif'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle'; for(let k=0;k<=4;k++){ const gy = padT + h*k/4; const val = Math.round(maxV - (maxV-minV)*k/4); ctx.fillText('Â¥'+val.toLocaleString('ja-JP'), padL-8, gy); }
    ctx.textAlign = 'center'; ctx.textBaseline = 'top'; for(let i=0;i<n;i+=Math.max(1, Math.floor(n/8))){ ctx.fillText(String(i+1), x(i), H-padB+6); }
    ctx.beginPath(); for(let i=0;i<n;i++){ const xi=x(i), yi=y(values[i]); if(i===0) ctx.moveTo(xi, yi); else ctx.lineTo(xi, yi); } ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2; ctx.stroke();
  }

  // Tabs
  const tab1 = document.getElementById('tab1'); const tab2 = document.getElementById('tab2');
  tab1.addEventListener('click', ()=>{ tab1.classList.add('active'); tab2.classList.remove('active'); panel1.style.display='block'; panel2.style.display='none'; });
  tab2.addEventListener('click', ()=>{ tab2.classList.add('active'); tab1.classList.remove('active'); panel2.style.display='block'; panel1.style.display='none'; });

  // Run/Reset/Export/Print
  document.getElementById('run').addEventListener('click', ()=>{ const res = buildSchedule(getInputs()); render(res); if(!document.getElementById('detail').open){ document.getElementById('detail').open = true; } });
  document.getElementById('reset').addEventListener('click', ()=>{
    priceEl.value = 3000000; feesEl.value = 200000; downEl.value = 300000; tradeinEl.value = 0; rateEl.value = 3.9; monthsEl.value = 60; startMonthEl.value = '';
    bonusAmountEl.value = 0; document.getElementById('bonusType').value = 'addon'; bonusJanEl.checked = true; bonusJulEl.checked = true; bonusJunEl.checked = false; bonusDecEl.checked = false;
    balloonYenEl.value = 0; balloonPctEl.value = 0; roundingEl.value = 'nearest'; balloonLast='yen';
    document.querySelector('input[name="mode"][value="annuity"]').checked = true;
    document.querySelector('#tbl tbody').innerHTML='';
    k_principal.textContent='-'; k_monthly.textContent='-'; k_total.textContent='-'; k_interest.textContent='-'; k_mode.textContent='å…ƒåˆ©å‡ç­‰';
  });
  document.getElementById('print').addEventListener('click', ()=>{ window.print(); });
  document.getElementById('export').addEventListener('click', ()=>{ const res = buildSchedule(getInputs()); const csv = toCSV(res); const now = new Date(); const name = `auto-loan-schedule_pro_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.csv`; download(name, csv); });

  // --- Self Tests (invariants + sync + price-base) ---
  function approx(a,b,eps=1){ return Math.abs(a-b) <= eps; }
  function runSelfTests(){
    const tests = [];
    // T1: ç„¡é‡‘åˆ©ãƒ»ãƒœãƒ¼ãƒŠã‚¹ç„¡ã—ãƒ»æ®‹ä¾¡ç„¡ã— â†’ ç·æ”¯æ‰• = å…ƒé‡‘ã€æœ€çµ‚æ®‹é«˜ = 0
    const inp1 = { price:1200000, fees:0, down:0, tradein:0, rateY:0, months:12, startDate:new Date(2025,0,1), bonusAmount:0, bonusType:'addon', bonusMonths:[], balloonPct:0, balloonYen:0, rounding:'nearest', mode:'annuity', balloonLast:'yen' };
    const r1 = buildSchedule(inp1); tests.push( approx(r1.totalPay, r1.principal) && approx(r1.rows[r1.rows.length-1].balance, 0) );
    // T2: ç„¡é‡‘åˆ©ãƒ»ãƒœãƒ¼ãƒŠã‚¹åŠ ç®—ï¼ˆ1/7æœˆï¼‰
    const inp2 = { ...inp1, bonusAmount:50000, bonusMonths:[0,6] }; const r2 = buildSchedule(inp2); tests.push( r2.rows.filter(x=>x.bonus>0).length===2 && approx(r2.rows.at(-1).balance, 0) );
    // T3: ç„¡é‡‘åˆ©ãƒ»ãƒœãƒ¼ãƒŠã‚¹ç·é¡æŒ‡å®šï¼ˆ1æœˆå›ºå®š15ä¸‡ï¼‰
    const inp3 = { ...inp1, bonusType:'total', bonusAmount:150000, bonusMonths:[0], months:6 }; const r3 = buildSchedule(inp3); tests.push( Math.round(r3.rows[0].pay)===150000 );
    // T4: æ®‹ä¾¡20%ï¼ˆæœ¬ä½“2,000,000Ã—20%â†’400,000ï¼‰
    const inp4 = { ...inp1, price:2000000, months:24, balloonPct:20, balloonLast:'pct' }; const r4 = buildSchedule(inp4); tests.push( (+r4.balloon) >= 399000 && (+r4.balloon) <= 401000 );
    // T5: pct->yen åŒæœŸï¼ˆä¸Šã¨åŒã˜æ¡ä»¶ã§ 20%â†’ç´„400,000 ã«ãªã‚‹ï¼‰
    priceEl.value=2000000; feesEl.value=0; downEl.value=0; tradeinEl.value=0; balloonPctEl.value='20';
    syncFromPct(); tests.push( Math.abs((+balloonYenEl.value) - 400000) <= 1000 );
    // T6: yen->pct åŒæœŸï¼ˆæœ¬ä½“2,000,000 ã® 250,000 â†’ 12.5% ä»˜è¿‘ï¼‰
    balloonYenEl.value='250000'; syncFromYen(); tests.push( Math.abs((+balloonPctEl.value) - 12.5) <= 0.2 );

    const ok = tests.every(Boolean);
    const el = document.getElementById('testStatus');
    el.textContent = ok ? 'âœ… å†…éƒ¨ãƒ†ã‚¹ãƒˆ: åˆæ ¼ï¼ˆæœ¬ä½“ä¾¡æ ¼ãƒ™ãƒ¼ã‚¹é©ç”¨ï¼‰' : 'âš ï¸ å†…éƒ¨ãƒ†ã‚¹ãƒˆ: å¤±æ•—ãŒã‚ã‚Šã¾ã™ï¼ˆF12 â†’ Consoleï¼‰';
    if(!ok) console.warn('SelfTests', tests);
  }

  enhanceNumericInputs();
  // initial
  document.getElementById('run').click();
  runSelfTests();
})();
</script>
</body>
</html>
