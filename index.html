<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="./icons/icon-192.png">

  <!-- ==== stylesï¼ˆå…ƒã®ã¾ã¾ï¼‰ ==== -->
  <style>
    :root{--bg:#0b1020;--surface:#0e1426;--muted:#9aa4b2;--text:#e6ecf3;--line:#1f2a44;--accent:#0ea5e9;--accent-2:#22d3ee;--radius:16px;--gap:14px;--shadow:0 14px 45px rgba(0,0,0,.38)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);background:
      radial-gradient(1200px 800px at 120% -10%, rgba(34,211,238,.08), transparent 60%),
      radial-gradient(1000px 600px at -10% 110%, rgba(14,165,233,.10), transparent 60%),
      var(--bg);
      font: clamp(16px,1.2vw + 12px,18px)/1.65 system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
    header{padding:24px 18px 10px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    h1{margin:0;font-size:clamp(20px,1.6vw + 14px,26px);letter-spacing:.2px}
    .sub{color:var(--muted);font-size:clamp(12px,.6vw + 10px,13.5px);margin-top:2px}
    main{padding:0 18px 28px;display:grid;grid-template-columns:500px 1fr;gap:20px;max-width:1280px;margin:0 auto}
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 18%);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:16px 16px;font-size:clamp(15px,.6vw + 12px,18px);border-bottom:1px dashed var(--line);color:#cbd5e1}
    .card .content{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px}
    .row-bonus-resid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:clamp(12.5px,.6vw + 10px,14px);color:var(--muted)}
    .field input,.field select{background:#0a1124;border:1px solid #1b2743;color:#e6ecf3;border-radius:12px;padding:14px 14px;outline:none;width:100%;max-width:100%;min-width:0;font-size:20px}
    .hint{font-size:clamp(12px,.5vw + 10px,13px);color:#7b879a}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;padding:0 14px 16px}
    button{appearance:none;border:none;cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#001018;font-weight:700;padding:14px 18px;border-radius:12px;box-shadow:var(--shadow);min-height:44px;font-size:16px}
    button.secondary{background:#0a1124;color:#e6ecf3;border:1px solid #1b2743;font-weight:600}
    .tabs{display:flex;gap:8px;padding:10px 14px 0;flex-wrap:wrap}
    .tab{padding:10px 12px;border:1px solid #1b2743;border-radius:999px;font-size:14px;color:#9fb3d1;cursor:pointer}
    .tab.active{background:#0a1124}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:14px}
    .tile{background:#0a1124;border:1px solid #1b2743;border-radius:14px;padding:14px}
    .tile .label{font-size:13px;color:#9aa4b2}.tile .value{font-size:28px;font-weight:800;margin-top:6px;font-variant-numeric:tabular-nums;letter-spacing:.3px}.tile .subv{font-size:12.5px;color:#7b879a;margin-top:4px}
    .schedule{padding:6px 14px 16px}
    details{border-top:1px dashed var(--line)} details summary{padding:12px 0;cursor:pointer;color:#cbd5e1;font-size:16px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #12203f;padding:10px 10px;text-align:right;white-space:nowrap}
    th{color:#9fb3d1;font-weight:600;position:sticky;top:0;background:#0d1427}
    td:first-child,th:first-child{text-align:left}
    .footer{padding:10px 14px 20px;color:#7b879a;font-size:12.5px}
    .chartWrap{padding:0 14px 18px} canvas{width:100%;height:340px;display:block;background:#0a1124;border:1px solid #1b2743;border-radius:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{padding:8px 10px;border:1px solid #1b2743;border-radius:999px;font-size:13px;color:#9fb3d1}
    .mode{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mode label{display:flex;align-items:center;gap:6px;border:1px solid #1b2743;border-radius:999px;padding:8px 12px;font-size:14px;color:#9fb3d1}
    .spinV{position:relative;display:flex;align-items:stretch;width:100%}
    .spinV input{flex:1;padding-right:48px;text-align:right;font-variant-numeric:tabular-nums;letter-spacing:.3px}
    .spinV .vstep{position:absolute;top:50%;right:6px;transform:translateY(-50%);display:flex;flex-direction:column;gap:4px}
    .spinV .step{appearance:none;border:1px solid #1b2743;background:#0a1124;color:#e6ecf3;border-radius:6px;width:32px;height:22px;font-size:12px;font-weight:800;line-height:1;display:grid;place-items:center;cursor:pointer}
    .spinV .step:active{transform:translateY(1px)}
    @media (min-width:701px){.row3{grid-template-columns:minmax(110px,.9fr) minmax(110px,.9fr) minmax(220px,1.2fr)}
      #months{max-width:120px} #rateWrap{max-width:280px}
      .spinV .step{width:26px;height:20px;font-size:11px;border-radius:4px}
      .spinV input{padding-right:48px} .spinV .vstep{right:6px;gap:2px}}
    @media (max-width:700px){.row,.row3{grid-template-columns:1fr} .grid2{grid-template-columns:1fr}
      .tile .value{font-size:30px} table{font-size:15px} th,td{padding:12px 10px} canvas{height:380px}
      .field input,.field select{font-size:clamp(22px,6vw,30px);padding:16px 16px;min-height:56px}
      .field label{font-size:clamp(14px,3.6vw,18px)} button{min-height:54px;font-size:17px}
      .spinV input{padding-right:56px} .spinV .step{width:36px;height:26px;font-size:13px}}
    .assist{display:block;margin-top:6px;font-size:12px;color:#9fb3d1}
    .assist:hover{color:#cfe1ff;text-decoration:underline}
    /* å®Ÿè³ªå¹´ç‡Â±ã•ã‚‰ã«å°ã•ã */
    .spinV .step{width:20px!important;height:14px!important;font-size:10px!important;border-radius:4px!important;padding:0!important}
    .spinV .vstep{gap:4px!important;right:4px!important}
    .spinV input{padding-right:44px!important}
  </style>
</head>

<body>
<header>
  <div class="logo">ğŸš—</div>
  <div>
    <h1>è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼PRO</h1>
    <div class="sub">å…ƒåˆ©å‡ç­‰ï¼å…ƒé‡‘å‡ç­‰ãƒ»ãƒœãƒ¼ãƒŠã‚¹â€¦</div>
  </div>
  <button id="btnInstall" hidden style="margin-left:auto">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
</header>

<main>
  <!-- ==== å…¥åŠ›ã‚«ãƒ¼ãƒ‰ï¼ˆå…ƒã®ã¾ã¾ / idã¯æ—¢å­˜ã«åˆã‚ã›ã¦ï¼‰ ==== -->
  <section class="card" id="inputs">
    <h2>å…¥åŠ›ï¼ˆæ—¥æœ¬å›½å†…å‘ã‘ï¼‰</h2>
    <div class="content">
      <div class="row">
        <div class="field">
          <label>è»Šä¸¡æœ¬ä½“ä¾¡æ ¼ <span class="muted">ï¼ˆç¨è¾¼æƒ³å®šï¼‰</span></label>
          <input type="text" data-num="money" id="price" value="3000000" inputmode="numeric" autocomplete="off" autofocus>
        </div>
        <div class="field">
          <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»è«¸è²»ç”¨</label>
          <input type="text" data-num="money" id="fees" value="200000" inputmode="numeric" autocomplete="off">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>é ­é‡‘</label>
          <input type="text" data-num="money" id="down" value="300000" inputmode="numeric" autocomplete="off">
        </div>
        <div class="field">
          <label>ä¸‹å–ã‚Šï¼ˆå·®å¼•å¾Œï¼‰</label>
          <input type="text" data-num="money" id="tradein" value="0" inputmode="numeric" autocomplete="off">
        </div>
      </div>

      <div class="row3">
        <div class="field" id="rateWrap">
          <label>å®Ÿè³ªå¹´ç‡ï¼ˆ%ï¼‰</label>
          <div class="spinV">
            <input type="text" id="rate" value="3.9" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" autocomplete="off">
            <div class="vstep">
              <button type="button" class="step" id="rateInc" aria-label="å¹´ç‡ã‚’0.05ä¸Šã’ã‚‹">â–²</button>
              <button type="button" class="step" id="rateDec" aria-label="å¹´ç‡ã‚’0.05ä¸‹ã’ã‚‹">â–¼</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label>è¿”æ¸ˆå›æ•°ï¼ˆæœˆï¼‰</label>
          <input type="number" id="months" value="60" min="1" step="1">
        </div>
        <div class="field">
          <label>é–‹å§‹æœˆ <span class="muted">ï¼ˆåˆå›å¼•è½æƒ³å®šï¼‰</span></label>
          <input type="month" id="startMonth">
        </div>
      </div>

      <div class="row-bonus-resid">
        <div class="field" id="bonusField">
          <label>ãƒœãƒ¼ãƒŠã‚¹é¡</label>
          <input type="text" data-num="money" id="bonusAmount" value="0" inputmode="numeric" autocomplete="off">
          <div style="margin-top:6px">
            <select id="bonusType">
              <option value="addon" selected>åŠ ç®—ï¼ˆé€šå¸¸æœˆã«ä¸Šä¹—ã›ï¼‰</option>
              <option value="total">ç·é¡æŒ‡å®šï¼ˆãã®æœˆã®ç·æ”¯æ‰•é¡ï¼‰</option>
            </select>
          </div>
          <div class="chips" style="margin-top:8px">
            <label class="chip"><input type="checkbox" id="bonusDec"> 12æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusJan" checked> 1æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusFeb"> 2æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusJul"> 7æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusAug" checked> 8æœˆ</label>
            <label class="chip"><input type="checkbox" id="bonusSep"> 9æœˆ</label>
          </div>
          <div class="hint">ç·é¡æŒ‡å®šã¯é€šå¸¸æ”¯æ‰•é¡ã‚’ä¸‹å›ã‚Œã¾ã›ã‚“ï¼ˆè‡ªå‹•ã§é€šå¸¸é¡ã¾ã§å¼•ãä¸Šã’ï¼‰ã€‚</div>
        </div>
        <div class="field">
          <label>æ®‹ä¾¡è¨­å®š</label>
          <div class="grid2">
            <input type="text" data-num="money" id="balloonYen" value="0" inputmode="numeric" autocomplete="off" placeholder="æ®‹ä¾¡ï¼ˆå††ï¼‰">
            <input type="text" id="balloonPct" value="0" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" autocomplete="off" placeholder="æ®‹ä¾¡ï¼ˆï¼…ï¼‰">
          </div>
          <div class="hint" id="balloonHint">
            æ®‹ä¾¡ç‡ã®åŸºæº–ï¼š<strong>è»Šä¸¡æœ¬ä½“ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</strong>ã€‚ä¸Šé™ã¯å…ƒé‡‘ã®90%ï¼ˆæ®‹ä¾¡ã¯<strong>ç™¾å††å˜ä½</strong>ï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ç«¯æ•°å‡¦ç†</label>
          <select id="rounding">
            <option value="none">ã—ãªã„ï¼ˆå††å˜ä½ï¼‰</option>
            <option value="down">æ¯å›ï¼šåˆ‡ã‚Šæ¨ã¦</option>
            <option value="nearest" selected>æ¯å›ï¼šå››æ¨äº”å…¥</option>
            <option value="up">æ¯å›ï¼šåˆ‡ã‚Šä¸Šã’</option>
          </select>
        </div>
        <div class="field">
          <label>è¿”æ¸ˆæ–¹å¼</label>
          <div class="mode">
            <label><input type="radio" name="mode" value="annuity" checked> å…ƒåˆ©å‡ç­‰</label>
            <label><input type="radio" name="mode" value="equal_principal"> å…ƒé‡‘å‡ç­‰</label>
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="run">è¨ˆç®—ã™ã‚‹</button>
      <button id="reset" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="print" class="secondary">PDFå‡ºåŠ›</button>
      <button id="export" class="secondary">CSVæ›¸ãå‡ºã—</button>
    </div>
  </section>

  <section class="card">
    <div class="tabs">
      <div class="tab active" id="tab1">çµæœã‚µãƒãƒªãƒ¼</div>
      <div class="tab" id="tab2">æ®‹é«˜ã‚°ãƒ©ãƒ•</div>
    </div>
    <div id="panel1">
      <div class="kpi">
        <div class="tile">
          <div class="label">å€Ÿå…¥é‡‘é¡ï¼ˆå…ƒé‡‘ï¼‰</div>
          <div id="k_principal" class="value">-</div>
          <div class="subv">ï¼ˆç·æ”¯æ‰• - åˆ©æ¯ - æ‰‹å…ƒæ”¯æ‰•ï¼‰</div>
        </div>
        <div class="tile">
          <div class="label">æ¯æœˆã®åŸºæœ¬è¿”æ¸ˆï¼ˆãƒœãƒ¼ãƒŠã‚¹é™¤ãï¼‰</div>
          <div id="k_monthly" class="value">-</div>
          <div class="subv"><span id="k_mode">å…ƒåˆ©å‡ç­‰</span>ãƒ»é¸æŠæœˆã¯ãƒœãƒ¼ãƒŠã‚¹åæ˜ </div>
        </div>
        <div class="tile">
          <div class="label">ç·æ”¯æ‰•é¡</div>
          <div id="k_total" class="value">-</div>
          <div class="subv">ã†ã¡åˆ©æ¯ï¼š<span id="k_interest">-</span></div>
        </div>
      </div>
      <div class="schedule">
        <details id="detail">
          <summary>è¿”æ¸ˆäºˆå®šè¡¨ã‚’é–‹ã</summary>
          <div style="overflow:auto; max-height:55vh; margin-top:10px">
            <table id="tbl">
              <thead>
              <tr>
                <th>å›</th><th>æ”¯æ‰•æ—¥</th><th>æ”¯æ‰•é¡</th><th>ã†ã¡ãƒœãƒ¼ãƒŠã‚¹</th><th>ã†ã¡æ®‹ä¾¡</th><th>åˆ©æ¯</th><th>å…ƒé‡‘</th><th>æ®‹é«˜</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
      <div class="footer" id="testStatus"></div>
    </div>
    <div id="panel2" style="display:none">
      <div class="chartWrap"><canvas id="chart" width="800" height="320" aria-label="æ®‹é«˜ã®æ¨ç§»"></canvas></div>
      <div class="footer">æ®‹é«˜ã‚°ãƒ©ãƒ•ï¼šç¸¦è»¸ï¼æ®‹é«˜ï¼ˆå††ï¼‰ã€æ¨ªè»¸ï¼å›æ•°ï¼ˆ1ã€œNï¼‰ã€‚</div>
    </div>
  </section>
</main>

<!-- å‰å›å…¥åŠ›ã‚¢ã‚·ã‚¹ãƒˆï¼ˆlocalStorageï¼‰ -->
        <script>
            (function () {
                const STORE_KEY = "autoLoanPRO:last-v2";
                const TARGETS = ["price", "fees", "down", "tradein", "rate", "months", "bonusAmount", "balloonYen", "balloonPct"];
                function saveState() {
                    const s = {}; TARGETS.forEach(id => { const el = document.getElementById(id); if (el) s[id] = el.value; });
                    localStorage.setItem(STORE_KEY, JSON.stringify(s));
                }
                function showAssist() {
                    let s = {}; try { s = JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); } catch (_) { }
                    TARGETS.forEach(id => {
                        const el = document.getElementById(id); if (!el) return;


                        // æ—¢å­˜ showAssist å†…ã®è©²å½“éƒ¨åˆ†ã‚’ã“ã®å½¢ã«
                        const container = el.closest(".field") || el.parentNode;  // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ
                        let prev = container.querySelector(".assist");
                        if (!s[id]) { if (prev) prev.remove(); return; }
                        if (!prev) {
                            prev = document.createElement("small");
                            prev.className = "assist";
                            container.appendChild(prev);   // â† .fieldç›´ä¸‹ã«ç½®ã
                        }
                        prev.textContent = "å‰å›: " + s[id];
                        prev.onclick = () => {
                            el.value = s[id];
                            el.dispatchEvent(new Event("input", { bubbles: true }));
                            el.dispatchEvent(new Event("change", { bubbles: true }));
                        };

                    });
                }
                TARGETS.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const handler = () => { saveState(); showAssist(); };
                    el.addEventListener("change", handler);
                    el.addEventListener("input", handler);   // â† è¿½åŠ ï¼ˆä»»æ„ï¼‰
                });

                window.addEventListener("load", showAssist);
            })();
        </script>

<!-- ==== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«èª˜å°ï¼ˆbeforeinstallpromptï¼‰ ==== -->
<script>
let deferredPrompt=null;
const installBtn=document.getElementById("btnInstall");
window.addEventListener("beforeinstallprompt",(e)=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
installBtn?.addEventListener("click",async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});
const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
if(isIOS&&!isStandalone){console.log("iOS: å…±æœ‰â†’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ");}
</script>

<!-- ==== PWA è‡ªå·±è¨ºæ–­ï¼ˆmanifest.json ã«åˆã‚ã›ã¦ä¿®æ­£ï¼‰ ==== -->
<script>
(function(){
  const box=document.createElement('div');
  box.style.cssText="position:fixed;right:12px;bottom:12px;z-index:99999;font:12px/1.5 system-ui;padding:10px 12px;border-radius:10px;background:#111;color:#e2e8f0;border:1px solid #334155";
  box.innerHTML='<b>PWAè‡ªå·±è¨ºæ–­</b><div id="p"></div>';
  document.body.appendChild(box);
  const p=box.querySelector('#p');
  const li=(k,v)=>{const d=document.createElement('div');d.textContent=`${k}: ${v}`;p.appendChild(d);};
  (async()=>{
    const base=location.pathname.replace(/[^/]+$/,'');
    const manHref=base+'manifest.json';
    li("manifest link", !!document.querySelector('link[rel=\"manifest\"]'));
    try{const r=await fetch(manHref,{cache:'no-store'});li("manifest fetch", r.status);}catch(_){li("manifest fetch","ERR");}
    if("serviceWorker" in navigator){
      const reg=await navigator.serviceWorker.getRegistration(base);
      li("SW reg", reg? "yes":"no");
      li("SW control", !!navigator.serviceWorker.controller);
    } else { li("SW","unsupported"); }
  })();
})();
</script>

<!-- ==== Service Workerç™»éŒ²ï¼ˆ1ã‹æ‰€ã®ã¿ / ã‚µãƒ–ãƒ‘ã‚¹å¯¾å¿œï¼‰ ==== -->
<script>
(function(){
  if(!('serviceWorker' in navigator)) return;
  const base = location.pathname.replace(/[^/]+$/,'');
  navigator.serviceWorker.register(base + 'sw.js', {scope: base});
})();
</script>

<!-- ==== æœ€å°ãƒ‘ãƒƒãƒï¼šå¹´ç‡Â± ã¨ æ®‹ä¾¡ï¼…â†”å†† ==== -->
<script>
(()=> {
  // å¹´ç‡ Â±ï¼ˆãã®ã¾ã¾ï¼‰
  const rate = document.getElementById('rate');
  const inc  = document.getElementById('rateInc');
  const dec  = document.getElementById('rateDec');
  const step = 0.05;
  const parse = () => parseFloat((rate.value||'').replace(/[^0-9.]/g,'')) || 0;
  const set   = v => {
    const val = Math.max(0, Math.round(v*100)/100);
    rate.value = String(val);
    rate.dispatchEvent(new Event('input',{bubbles:true}));
    rate.dispatchEvent(new Event('change',{bubbles:true}));
  };
  inc?.addEventListener('click', ()=> set(parse()+step));
  dec?.addEventListener('click', ()=> set(parse()-step));

  // æ®‹ä¾¡ ï¼…â†”å††
  const price = document.getElementById('price');
  const fees  = document.getElementById('fees');
  const down  = document.getElementById('down');
  const trade = document.getElementById('tradein');
  const pctEl = document.getElementById('balloonPct');
  const yenEl = document.getElementById('balloonYen');
  const hint  = document.getElementById('balloonHint');

  const basePrice = ()=> (parseInt(price.value||0)||0); // ç‡ã®åŸºæº–ï¼šè»Šä¸¡æœ¬ä½“ï¼ˆç¨è¾¼ï¼‰
  const principal = ()=> Math.max(0, basePrice() + (parseInt(fees.value||0)||0)
                                      - (parseInt(down.value||0)||0)
                                      - (parseInt(trade.value||0)||0));
  const clampPct = p => Math.max(0, Math.min(p, 90));        // 90% ã¾ã§OKï¼ˆå…¥åŠ›ä¿æŒï¼‰
  const clampYen = y => Math.max(0, Math.min(y, Math.floor(principal()*0.9))); // ä¸Šé™ï¼å…ƒé‡‘ã®90%
  const r100 = v => Math.round(v/100)*100; // ç™¾å††å˜ä½

  // ï¼… â†’ é‡‘é¡ï¼ˆï¼…æ¬„ã¯æ›¸ãæ›ãˆãªã„ï¼å…¥åŠ›ãã®ã¾ã¾ä¿æŒï¼‰
  pctEl?.addEventListener('input', ()=>{
    const pIn   = parseFloat(pctEl.value)||0;
    const p     = clampPct(pIn);
    const ideal = r100(basePrice()*p/100);
    const cap   = Math.floor(principal()*0.9);
    const y     = clampYen(ideal);
    yenEl.value = String(y);

    // ä¸Šé™ã«å½“ãŸã£ãŸã‹è¡¨ç¤º
    if (y < ideal && cap >= 0) {
      hint.textContent = `åŸºæº–=è»Šä¸¡æœ¬ä½“: Â¥${basePrice().toLocaleString('ja-JP')}ï½œå…¥åŠ› ${p.toFixed(1)}% â†’ é‡‘é¡ã¯ä¸Šé™(å…ƒé‡‘ã®90%: Â¥${cap.toLocaleString('ja-JP')})ã§åˆ¶é™ä¸­`;
    } else {
      hint.textContent = `æ®‹ä¾¡ç‡ã®åŸºæº–ï¼šè»Šä¸¡æœ¬ä½“ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰ã€‚ä¸Šé™ã¯å…ƒé‡‘ã®90%ï¼ˆæ®‹ä¾¡ã¯ç™¾å††å˜ä½ï¼‰ã€‚`;
    }

    // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯èµ·å‹•
    yenEl.dispatchEvent(new Event('input',{bubbles:true}));
    yenEl.dispatchEvent(new Event('change',{bubbles:true}));
  });

  // é‡‘é¡ â†’ ï¼…ï¼ˆé‡‘é¡ã‹ã‚‰é€†ç®—ã—ãŸè¦‹ã‹ã‘ã®ï¼…ã‚’è¡¨ç¤ºã€ãŸã ã—90ã§æ‰“ã¡æ­¢ã‚ï¼‰
  yenEl?.addEventListener('input', ()=>{
    const y = clampYen(parseInt(yenEl.value||0)||0);
    const b = basePrice();
    const p = b>0 ? (y/b*100) : 0;
    pctEl.value = clampPct(p).toFixed(1);

    hint.textContent = `æ®‹ä¾¡ç‡ã®åŸºæº–ï¼šè»Šä¸¡æœ¬ä½“ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰ã€‚ä¸Šé™ã¯å…ƒé‡‘ã®90%ï¼ˆæ®‹ä¾¡ã¯ç™¾å††å˜ä½ï¼‰ã€‚`;
    pctEl.dispatchEvent(new Event('input',{bubbles:true}));
    pctEl.dispatchEvent(new Event('change',{bubbles:true}));
  });
})();
</script>


</body>
</html>
