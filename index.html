function compute(){
  recalcLoanAmt();

  const loan   = Math.max(+($("loanAmt").value||0),0);
  const rate   = Math.min(+($("rate").value||0),30);
  const months = Math.max(Math.min(+($("months").value||0),120),1);

  const balloonAmt   = Math.max(+($("balloonAmt").value||0),0);
  const bonusTimes   = Math.min(+($("bonusTimes").value||0),4);
  const mode         = document.querySelector('input[name="bonusMode"]:checked')?.value||"add";
  const bonusAmt     = (bonusTimes===0)?0:Math.max(+($("bonusAmt").value||0),0);
  const bonusTotal   = (bonusTimes===0)?0:Math.max(+($("bonusTotal").value||0),0);

  const r = rate/100/12;

  // 満期に残す残価（ローンを下回らない）
  const effectiveResidual = Math.min(balloonAmt, loan);

  // ★残価つきPMT：満期残高＝残価額になる毎月額
  let monthly = 0;
  if (r === 0) {
    monthly = Math.round((loan - effectiveResidual) / months);
  } else {
    const pow = Math.pow(1+r, months);
    monthly = Math.round( r * (loan * pow - effectiveResidual) / (pow - 1) );
  }

  // ★返済の起点残高はローン全額（残価は下限）
  let bal = loan;

  let totalPay = 0;
  let totalInt = 0;
  const tb = $("tbody"); tb.innerHTML = "";

  const interval = bonusTimes>0 ? Math.max(1, Math.round(12/bonusTimes)) : 0;

  for (let i=1;i<=months;i++){
    const interest = Math.round(bal * r);

    let basePay = monthly;
    let bonus = 0;
    const isBonus = interval && (i % interval) === 0;

    if (isBonus){
      if (mode === "add"){
        bonus = bonusAmt;             // 通常月+加算額
      } else {
        basePay = bonusTotal;         // その月の総額指定
      }
    }

    const pay = Math.round(mode === "add" ? (basePay + bonus) : basePay);

    // 利息は必ず支払う（万一の丸めで pay < interest の保険）
    const adjPay = Math.max(pay, interest);

    // この月に減らせる元金の上限：現在残高 − 残価（残価未満にしない）
    const maxPrincipal = Math.max(0, bal - effectiveResidual);
    let principal = Math.min(maxPrincipal, adjPay - interest);
    principal = Math.round(Math.max(0, principal));

    bal = Math.round(bal - principal);

    totalPay += adjPay;
    totalInt += interest;

    const shownBonus = isBonus ? (mode === "add" ? bonus : Math.max(0, adjPay - monthly)) : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i}</td>
      <td>${fmt.format(adjPay)}</td>
      <td>${fmt.format(interest)}</td>
      <td>${fmt.format(principal)}</td>
      <td>${fmt.format(shownBonus)}</td>
      <td>${fmt.format(Math.max(0, bal))}</td>`;
    tb.appendChild(tr);
  }

  // 満期：残価の精算を総額に加算＋明細に追記
  let grandTotal = totalPay;
  if(effectiveResidual > 0){
    grandTotal += effectiveResidual;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>満期</td><td>${fmt.format(effectiveResidual)}</td><td>—</td><td>—</td><td>—</td><td>0</td>`;
    tb.appendChild(tr);
  }

  $("loan").textContent    = fmt.format(loan);
  $("monthly").textContent = fmt.format(monthly);
  $("total").textContent   = fmt.format(grandTotal);
  $("interest").textContent= fmt.format(totalInt);

  // CSV
  const rows=[["#","返済額","利息","元金","ボーナス","残高"]];
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    rows.push([...tr.children].map(td=>td.textContent.replace(/,/g,"")));
  });
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const dl=$("download"); dl.disabled=false;
  dl.onclick=()=>{const a=document.createElement("a");a.href=url;a.download="car_loan_schedule.csv";a.click();};

  // PDF ボタンの初期化（既存ロジックのままでOK）
  const pdfBtn=$("pdf"); pdfBtn.disabled=false;
}
