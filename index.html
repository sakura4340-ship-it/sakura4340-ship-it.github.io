<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>自動車ローン シミュレーター</title>

<!-- iPhone/PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="ローン計算">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>
  :root{--gap:12px;--radius:12px}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif}
  html,body{height:100%}
  body{margin:0;background:#0f172a;color:#e5e7eb;-webkit-text-size-adjust:100%}

  /* 文字選択禁止（入力欄だけ許可） */
  body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
  input,textarea{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}

  header{padding:24px 16px;text-align:center;background:linear-gradient(180deg,#111827,#0f172a)}
  header h1{margin:.2rem 0;font-size:clamp(20px,4vw,28px)}
  header p{margin:.2rem 0;color:#cbd5e1}
  main{max-width:1200px;margin:0 auto;padding:16px}
  .panel{background:#111827;border:1px solid #1f2937;border-radius:var(--radius);padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.2)}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  @media (max-width:880px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:#a5b4fc;margin-bottom:6px}
  input, select{width:100%;padding:12px 10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  input:focus{outline:2px solid #6366f1;border-color:#6366f1}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid #334155;background:#1f2937;color:#e5e7eb;padding:12px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#4f46e5;border-color:#4f46e5}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin-top:16px}
  @media (max-width:880px){.summary{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.summary{grid-template-columns:1fr}}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:14px}
  .card h3{margin:.2rem 0 .4rem;font-size:12px;color:#94a3b8;font-weight:600}
  .card .val{font-size:20px;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:16px;border:1px solid #1f2937}
  th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:right;font-variant-numeric:tabular-nums}
  th{position:sticky;top:0;background:#0b1220;color:#93c5fd;z-index:1}
  td:first-child,th:first-child{text-align:center}
  .scroll{max-height:55vh;overflow:auto;border-radius:12px;-webkit-overflow-scrolling:touch}
  footer{padding:24px;text-align:center;color:#94a3b8}
  .note{color:#9ca3af;font-size:12px;margin-top:6px}

  /* ====== 拡大入力パッド ====== */
  #zoom-scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
  #zoom-scrim.show{display:flex}
  .zoom-card{width:min(92vw,560px);background:#0b1220;border:1px solid #334155;border-radius:16px;box-shadow:0 40px 120px rgba(0,0,0,.5);transform-origin:center;animation:zoomIn .18s ease-out}
  @keyframes zoomIn{from{transform:perspective(1000px) translateY(24px) scale(.92) rotateX(6deg);opacity:0}to{transform:perspective(1000px) translateY(0) scale(1) rotateX(0);opacity:1}}
  .zoom-head{padding:16px 20px;font-size:14px;color:#93c5fd;border-bottom:1px solid #1f2937}
  .zoom-body{padding:16px 20px}
  .zoom-input{width:100%;font-size:clamp(36px,6vw,56px);line-height:1.2;padding:16px 18px;border-radius:14px;border:1px solid #475569;background:#0f172a;color:#e5e7eb;text-align:right;font-variant-numeric:tabular-nums}
  .zoom-keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:16px}
  .zoom-keys button{padding:18px 0;font-size:22px;border-radius:12px;border:1px solid #334155;background:#111827;color:#e5e7eb;cursor:pointer}
  .zoom-actions{display:flex;gap:10px;margin-top:16px}
  .zoom-actions .btn{flex:1;padding:14px;border-radius:12px;border:1px solid #334155;background:#1f2937;color:#e5e7eb;cursor:pointer}
  .zoom-actions .btn.primary{background:#4f46e5;border-color:#4f46e5}
</style>
</head>
<body>
<header>
  <h1>自動車ローン シミュレーション</h1>
  <p>残価設定ローン・ボーナス併用・繰上返済に対応（年配者向け拡大入力＋カンマ付き）</p>
</header>

<main>
  <section class="panel" aria-label="入力フォーム">
    <div class="grid">
      <div><label for="price">車両価格（円）</label><input id="price" type="number" value="3000000" min="0" inputmode="numeric"></div>
      <div><label for="down">頭金（円）</label><input id="down" type="number" value="500000" min="0" inputmode="numeric"></div>
      <div><label for="rate">年利（%）</label><input id="rate" type="number" value="3.0" step="0.01" min="0" max="20" inputmode="decimal"></div>
      <div><label for="years">返済年数（年）</label><input id="years" type="number" value="5" step="1" min="1" max="10" inputmode="numeric"></div>
      <div><label for="balloonPct">残価率（%）</label><input id="balloonPct" type="number" value="0" min="0" max="30" inputmode="numeric"></div>
      <div><label for="balloonAmt">残価額（円）</label><input id="balloonAmt" type="number" value="0" min="0" inputmode="numeric"></div>
      <div><label for="bonusAmt">ボーナス加算額（円）</label><input id="bonusAmt" type="number" value="0" min="0" inputmode="numeric"></div>
      <div><label for="bonusTimes">ボーナス回数（年）</label><input id="bonusTimes" type="number" value="2" min="0" max="4" inputmode="numeric"></div>
      <div><label for="extra">毎月の繰上返済額（円）</label><input id="extra" type="number" value="0" min="0" inputmode="numeric"></div>
      <div><label for="fees">初期手数料（円）</label><input id="fees" type="number" value="0" min="0" inputmode="numeric"></div>
    </div>

    <div class="row" style="margin-top:16px">
      <button id="calc" class="btn primary">計算する</button>
      <button id="download" class="btn" disabled>CSVダウンロード</button>
    </div>

    <div id="errors" style="margin-top:8px;color:#fecaca;background:#7f1d1d;padding:8px 10px;border-radius:8px;display:none"></div>

    <div class="summary">
      <div class="card"><h3>借入額</h3><div id="loan" class="val">-</div></div>
      <div class="card"><h3>毎月返済額</h3><div id="monthly" class="val">-</div></div>
      <div class="card"><h3>総支払額</h3><div id="total" class="val">-</div></div>
      <div class="card"><h3>利息総額</h3><div id="interest" class="val">-</div></div>
    </div>
  </section>

  <section class="panel" style="margin-top:16px">
    <div class="scroll">
      <table id="table">
        <thead><tr><th>#</th><th>年月</th><th>返済額</th><th>うち利息</th><th>うち元金</th><th>繰上返済</th><th>ボーナス</th><th>残高</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<footer><small>© 2025 Auto Loan Simulator</small></footer>

<!-- 拡大入力パッド -->
<div id="zoom-scrim" aria-hidden="true">
  <div class="zoom-card" role="dialog" aria-modal="true" aria-label="拡大入力">
    <div class="zoom-head">大きな数値入力</div>
    <div class="zoom-body">
      <input id="zoomValue" class="zoom-input" type="text" inputmode="numeric" aria-label="数値（カンマ表示）">
      <div class="zoom-keys">
        <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k=",">,</button>
        <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button data-k="00">00</button>
        <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button data-k="0">0</button>
        <button data-k="←">⌫</button>
      </div>
      <div class="zoom-actions">
        <button id="zoomCancel" class="btn">キャンセル</button>
        <button id="zoomOk" class="btn primary">決定</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const fmt = new Intl.NumberFormat('ja-JP',{maximumFractionDigits:0});
  const fmtYen = v => (isFinite(v)? fmt.format(Math.round(v)) : "-");
  const $ = id => document.getElementById(id);

  // ======= 入力制限とバリデーション =======
  const limits = { balloonPct:30, years:10, bonusTimes:4 };
  const ids = ["price","down","rate","years","balloonPct","balloonAmt","bonusAmt","bonusTimes","extra","fees"];
  const err = $("errors");
  function showError(m){ err.textContent=m; err.style.display="block"; }
  function clearError(){ err.style.display="none"; }
  function clampById(id,val){
    if(id in limits){ return Math.min(+val||0, limits[id]); }
    return +val||0;
  }

  // 自動保存/復元
  const KEY="car-loan-form-v1";
  function save(){ localStorage.setItem(KEY, JSON.stringify(Object.fromEntries(ids.map(i=>[i,$(i).value])))); }
  function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||"null"); if(d){ ids.forEach(i=>{ if(d[i]!=null) $(i).value=d[i]; }); } }catch{} }
  window.addEventListener("load", load);
  ids.forEach(i=>$(i).addEventListener("change", save));

  // ======= 計算 =======
  function compute(){
    clearError();
    // 値取り込み＆上限クランプ
    const price = clampById("price", $("price").value);
    const down  = clampById("down", $("down").value);
    const rate  = Math.min(Math.max(+$("rate").value||0,0),20);
    const years = clampById("years", $("years").value);
    const balloonPct = clampById("balloonPct", $("balloonPct").value);
    const balloonAmt = clampById("balloonAmt", $("balloonAmt").value);
    const bonusAmt   = clampById("bonusAmt", $("bonusAmt").value);
    const bonusTimes = clampById("bonusTimes", $("bonusTimes").value);
    const extra = clampById("extra", $("extra").value);
    const fees  = clampById("fees", $("fees").value);

    if(price<=0) return showError("車両価格は1円以上を入力してください。");
    if(down<0 || down>price) return showError("頭金は0〜車両価格の範囲にしてください。");

    const loan = Math.max(0, price - down);
    const months = Math.round(years*12);
    const r = rate/100/12;

    const residual = balloonAmt>0 ? Math.min(loan,balloonAmt) : loan*(balloonPct/100);
    const financed = Math.max(0, loan - residual);

    let monthly;
    if(r===0){ monthly = financed/months; }
    else{ const pow=Math.pow(1+r,months); monthly = financed*(r*pow)/(pow-1); }

    const tbody = $("table").querySelector("tbody"); tbody.innerHTML="";
    let bal=financed,totalPay=0,totalInt=0;
    const interval = (bonusTimes>0 && bonusTimes<=4)? Math.max(1, Math.round(12/bonusTimes)) : 0;

    for(let i=1;i<=months;i++){
      const interest = r===0?0:bal*r;
      let principal = Math.min(bal, monthly - interest);
      let prepay = Math.min(extra, Math.max(0, bal - principal));
      let bonus = 0;
      if(interval && bonusAmt>0 && (i%interval)===0){
        bonus = Math.min(bonusAmt, Math.max(0, bal - principal - prepay));
      }
      if(i===months){ // 最終月：端数調整
        principal = bal - prepay - bonus;
        monthly = principal + interest;
      }
      bal -= (principal + prepay + bonus);
      totalPay += (monthly + prepay + bonus);
      totalInt += interest;

      const tr=document.createElement("tr");
      [i, `${i}ヶ月目`, fmtYen(monthly+prepay+bonus), fmtYen(interest), fmtYen(principal), fmtYen(prepay), fmtYen(bonus), fmtYen(Math.max(0,bal))]
      .forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); });
      tbody.appendChild(tr);
    }

    if(residual>0){
      const tr=document.createElement("tr");
      ["満期","", fmtYen(residual),"—","—","—","—", fmtYen(0)]
      .forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); });
      tbody.appendChild(tr);
      totalPay += residual;
    }

    $("loan").textContent = fmtYen(loan);
    $("monthly").textContent = fmtYen(monthly + (extra||0));
    $("total").textContent = fmtYen(totalPay + fees);
    $("interest").textContent = fmtYen(totalInt);

    // CSV
    const rows=[["#","年月","返済額","うち利息","うち元金","繰上返済","ボーナス","残高"]];
    tbody.querySelectorAll("tr").forEach(tr=>{
      rows.push([...tr.children].map(td=>td.textContent.replace(/,/g,"")));
    });
    const csvText=rows.map(r=>r.join(",")).join("\n");
    const url=URL.createObjectURL(new Blob([csvText],{type:"text/csv;charset=utf-8"}));
    $("download").disabled=false; $("download").onclick=()=>{const a=document.createElement("a");a.href=url;a.download="car_loan.csv";a.click();}

    save();
  }
  $("calc").addEventListener("click", compute);
  compute(); // 初回

  // ======= マウス系の誤操作防止 =======
  window.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});            // 右クリック無効
  window.addEventListener('mousedown', e=>{ if(e.button!==0) e.preventDefault(); }, {capture:true}); // 左以外無効
  window.addEventListener('auxclick', e=>e.preventDefault(), {capture:true});               // 中クリック新規タブ抑止
  history.pushState(null,'',location.href); window.addEventListener('popstate',()=>history.pushState(null,'',location.href)); // 戻る進む無効
  // 数値入力のホイール増減を抑止
  document.querySelectorAll('input[type="number"]').forEach(el=>{
    el.addEventListener('wheel', e=>e.preventDefault(), {passive:false});
  });

  // ======= 拡大入力パッド（カンマ表示＋カンマキー付き） =======
  const scrim = $("zoom-scrim");
  const zInput = $("zoomValue");
  let src = null;

  const unformat = s => (s||"").toString().replace(/[^\d\-]/g,"");
  const withCommas = s => {
    if(!s) return "";
    const neg = s.startsWith("-") ? "-" : "";
    s = s.replace(/^-/, "");
    return neg + s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };

  document.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.setAttribute("inputmode","numeric");
    function open(){
      src = inp;
      zInput.value = withCommas(unformat(inp.value||""));
      scrim.classList.add("show");
      document.body.style.overflow = "hidden";
      setTimeout(()=>{ zInput.focus(); zInput.select(); }, 0);
    }
    inp.addEventListener("focus",(e)=>{ e.preventDefault(); inp.blur(); open(); }, {passive:false});
    inp.addEventListener("click",(e)=>{ e.preventDefault(); inp.blur(); open(); }, {passive:false});
  });

  scrim.querySelectorAll(".zoom-keys button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const k=b.dataset.k;
      if(k==="←"){
        const raw = unformat(zInput.value);
        zInput.value = withCommas(raw.slice(0,-1));
        return;
      }
      if(k===","){ // カンマキー：再整形のみ（視覚的一貫性）
        const raw = unformat(zInput.value);
        zInput.value = withCommas(raw);
        return;
      }
      const raw = unformat(zInput.value) + (k==="00" ? "00" : k);
      zInput.value = withCommas(raw);
    });
  });

  zInput.addEventListener("input", ()=>{
    const raw = unformat(zInput.value);
    zInput.value = withCommas(raw);
    zInput.selectionStart = zInput.selectionEnd = zInput.value.length;
  });

  function close(commit){
    if(commit && src){
      let numeric = parseInt(unformat(zInput.value)||"0",10);
      // 上限クランプ（指定項目のみ）
      const id = src.id;
      if(id in limits) numeric = Math.min(numeric, limits[id]);
      src.value = isFinite(numeric)? numeric : 0;
      src.dispatchEvent(new Event("input",{bubbles:true}));
      src.dispatchEvent(new Event("change",{bubbles:true}));
    }
    scrim.classList.remove("show");
    document.body.style.overflow = "";
    src=null;
  }
  $("zoomOk").addEventListener("click", ()=>close(true));
  $("zoomCancel").addEventListener("click", ()=>close(false));
  scrim.addEventListener("click", e=>{ if(e.target===scrim) close(false); });
  document.addEventListener("keydown", e=>{
    if(!scrim.classList.contains("show")) return;
    if(e.key==="Escape") close(false);
    if(e.key==="Enter") close(true);
  });
})();
</script>
</body>
</html>
